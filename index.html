<!-- Chosen Palette: OSRS Natural (Warm Neutrals, Earthy Greens, UI Browns) + Dark Mode -->
<!-- Application Structure Plan: 
    - UPDATE: Fireworks logic isolated to Route items only.
    - UPDATE: Removed Catherby manual checkbox.
    - LOGIC: Catherby Teleport determined automatically by Stats + Lunar Checkbox.
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barker's Farm Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Confetti Library for Fireworks -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cinzel:wght@700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Cinzel', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .mode-btn { transition: all 0.2s; border: 2px solid #3d5c25; }
        .mode-btn.active { background-color: #3d5c25; color: white; border-color: #2e461b; }
        
        .dark .mode-btn { border-color: #86efac; color: #86efac; background-color: transparent; }
        .dark .mode-btn.active { background-color: #86efac; color: #064e3b; border-color: #86efac; }

        .phase-header {
            display: flex; align-items: center; justify-content: center; margin: 2rem 0;
            font-weight: bold; font-family: 'Cinzel', serif; font-size: 1.25rem;
            padding: 10px; border-radius: 8px; border-width: 1px;
        }

        /* Interactive Row Styling */
        .interactive-row {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .interactive-row.completed {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #22c55e !important; /* green-500 */
            opacity: 0.8;
        }
        
        .dark .interactive-row.completed {
            background-color: #064e3b !important; /* green-900 */
            border-color: #4ade80 !important; /* green-400 */
            opacity: 0.9;
        }

        /* Table Styling */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .ref-table th { background-color: #3d5c25; color: white; padding: 10px; text-align: left; font-weight: 600; }
        .ref-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; }
        .dark .ref-table td { border-bottom: 1px solid #4b5563; }
        .ref-table tr:nth-child(even) { background-color: #f9fafb; }
        .dark .ref-table tr:nth-child(even) { background-color: #374151; }

        /* API Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3d5c25;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .stat-box {
            display: flex; flex-direction: column; align-items: center;
            padding: 0.5rem; border-radius: 0.5rem;
        }

        /* Lobster Animation */
        @keyframes dance {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg) scale(1.1); }
        }
        .lobster-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 200px;
        }
        .lobster {
            font-size: 8rem;
            cursor: pointer;
            animation: dance 1s infinite ease-in-out;
            display: inline-block;
            text-decoration: none;
        }
    </style>
</head>
<body class="bg-[#f0f0eb] text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="absolute top-4 right-4 bg-white dark:bg-gray-700 shadow-md p-2 rounded-full hover:scale-110 transition-transform z-50" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span id="theme-icon">üåô</span>
    </button>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <header class="mb-8 text-center relative pt-8 sm:pt-0">
            <h1 class="text-4xl font-bold text-[#3e2723] dark:text-[#e7d8c9] mb-2">Barker's Farm Run</h1>
            <h2 id="fun-quote" class="text-lg text-gray-500 dark:text-gray-400 font-semibold mb-6 italic min-h-[1.75rem]">"It ain't much, but it's honest work."</h2>
            
            <!-- INPUT SECTION -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 max-w-3xl mx-auto mb-8 border border-gray-200 dark:border-gray-700">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Column 1: Stats -->
                    <div>
                        <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase">Player Stats</h4>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="rsn-input" placeholder="OSRS Username" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#3d5c25]" onkeypress="handleEnter(event)">
                            <button onclick="fetchStats()" class="bg-[#3d5c25] hover:bg-[#2e461b] text-white px-3 py-2 rounded font-bold transition-colors flex items-center justify-center min-w-[80px]">
                                <span id="fetch-text">Fetch</span> <div id="api-loader" class="loader ml-2"></div>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="stat-box bg-green-50 dark:bg-green-900/30">
                                <span class="text-gray-500 dark:text-gray-400">Farming</span>
                                <span id="stat-farm" class="font-bold text-[#3d5c25] dark:text-green-400 text-lg">99</span>
                            </div>
                            <div class="stat-box bg-blue-50 dark:bg-blue-900/30">
                                <span class="text-gray-500 dark:text-gray-400">Magic</span>
                                <span id="stat-magic" class="font-bold text-blue-600 dark:text-blue-400 text-lg">99</span>
                            </div>
                            <div class="stat-box bg-orange-50 dark:bg-orange-900/30">
                                <span class="text-gray-500 dark:text-gray-400">Constr.</span>
                                <span id="stat-con" class="font-bold text-orange-600 dark:text-orange-400 text-lg">99</span>
                            </div>
                        </div>
                        <!-- Manual Slider Fallback -->
                        <div class="mt-4 pt-2 border-t border-gray-200 dark:border-gray-600">
                            <label class="text-xs font-semibold text-gray-500">Manual Farming Level</label>
                            <input type="range" min="1" max="99" value="99" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-pointer accent-[#3d5c25] mt-1" id="level-slider" oninput="updateStatsFromSlider()">
                        </div>
                    </div>

                    <!-- Column 2: Unlocks -->
                    <div class="border-l border-gray-200 dark:border-gray-600 pl-0 md:pl-6 pt-4 md:pt-0">
                        <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase">Unlock Settings</h4>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="check-angler" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()">
                                <span>Anglers' Retreat ("51 Sailing")</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="check-lunar" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()">
                                <span>Lunar Spellbook</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="check-ardy-hard" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()">
                                <span>Ardougne Hard/Elite Diary</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="check-lum-hard" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()">
                                <span>Lumbridge Hard/Elite Diary</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <input type="checkbox" id="check-elf" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()">
                                <span>Elf Questline (Prif/Lletya)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode Buttons -->
            <div class="flex justify-center flex-wrap gap-4 mb-4">
                <button onclick="switchMode('herb')" id="btn-herb" class="mode-btn active px-6 py-2 rounded-full font-bold transition-colors">
                    üåø Herb Run
                </button>
                <button onclick="switchMode('tree')" id="btn-tree" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">
                    üå≥ Tree Run
                </button>
                <button onclick="switchMode('reference')" id="btn-ref" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">
                    üìò Reference
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Inventory (Box styling will be removed via JS for Reference mode) -->
                <div id="inv-box" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#3d5c25] dark:border-green-500 transition-colors">
                    <h2 class="text-2xl font-bold mb-3 text-[#3d5c25] dark:text-green-400" id="prep-title">Inventory</h2>
                    <div id="inventory-container" class="space-y-4"></div>
                </div>

                <!-- Stats Panel -->
                <div id="stats-panel" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#5d4037] dark:border-orange-900 transition-colors">
                    <!-- Text Based XP Calc -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 text-center">
                        <p class="text-gray-500 dark:text-gray-400 text-xs uppercase font-bold tracking-wide mb-1">Expected XP Drop</p>
                        <p id="xp-display" class="text-3xl font-bold text-[#3d5c25] dark:text-green-400">0 XP</p>
                        <p id="xp-breakdown" class="text-xs text-gray-400 mt-2">Check Health + Harvest</p>
                    </div>
                </div>
            </div>

            <!-- Route Main Area -->
            <div class="lg:col-span-8">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg min-h-screen transition-colors">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-[#2e3b2b] dark:text-gray-100" id="route-title">The Route</h2>
                        <!-- Only for visual, logic handled by route check -->
                    </div>
                    
                    <div class="relative border-l-4 border-gray-200 dark:border-gray-700 ml-4 space-y-12" id="route-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        let userStats = { farming: 99, magic: 99, construction: 99 };
        let currentMode = 'herb';

        // Quotes
        const QUOTES = [
            "It ain't much, but it's honest work.",
            "Remember to pay your farmers!",
            "Did you grab your spade?",
            "Don't forget the compost!",
            "XP waste is a myth (mostly).",
            "Pet chance: 50/50. You get it or you don't.",
            "Hespori is waiting...",
            "Pleae.",
            "Farming: The skill of patience.",
            "Watch out for Tangleroot!"
        ];

        // Tree Definitions (No Crystal)
        const TREES = {
            wood: [
                { lvl: 75, name: "Magic", payQty: 25, payItem: "Coconuts", xp: 13768 },
                { lvl: 60, name: "Yew", payQty: 10, payItem: "Cactus Spines", xp: 7069 },
                { lvl: 45, name: "Maple", payQty: 1, payItem: "Basket of Oranges", xp: 3403 },
                { lvl: 15, name: "Oak", payQty: 1, payItem: "Basket of Tomatoes", xp: 481 }
            ],
            fruit: [
                { lvl: 81, name: "Dragonfruit", payQty: 15, payItem: "Coconut", xp: 17335 },
                { lvl: 68, name: "Palm", payQty: 15, payItem: "Papaya Fruit", xp: 10150 },
                { lvl: 57, name: "Papaya", payQty: 10, payItem: "Pineapple", xp: 6146 },
                { lvl: 27, name: "Apple", payQty: 9, payItem: "Sweetcorn", xp: 1199 }
            ],
            hardwood: [
                { lvl: 55, name: "Mahogany", payQty: 25, payItem: "Yanillian Hops", xp: 15720 },
                { lvl: 35, name: "Teak", payQty: 15, payItem: "Limpwurt Roots", xp: 7290 }
            ],
            calquat: [ { lvl: 72, name: "Calquat", payQty: 8, payItem: "Poison Ivy Berries", xp: 12096 } ],
            celastrus: [ { lvl: 85, name: "Celastrus", payQty: 8, payItem: "Potato Cactus", xp: 14130 } ],
            redwood: [ { lvl: 90, name: "Redwood", payQty: 6, payItem: "Dragonfruit", xp: 22450 } ]
        };

        const HERBS = [ { lvl: 85, name: "Torstol" }, { lvl: 32, name: "Ranarr" }, { lvl: 9, name: "Guam" } ];

        // --- QUOTE ROTATION ---
        function rotateQuotes() {
            const el = document.getElementById('fun-quote');
            let idx = 0;
            setInterval(() => {
                idx = (idx + 1) % QUOTES.length;
                el.innerText = `"${QUOTES[idx]}"`;
            }, 5000);
        }

        // --- SMART TELEPORT ENGINE ---
        function getSmartTele(location) {
            const con = userStats.construction;
            const mag = userStats.magic;
            const lunar = document.getElementById('check-lunar').checked;
            const ardyHard = document.getElementById('check-ardy-hard').checked; 
            const lumHard = document.getElementById('check-lum-hard').checked; 
            const elf = document.getElementById('check-elf').checked;
            const hasNexus = con >= 83; 
            const hasSpiritTree = con >= 83; 
            const hasJbox = con >= 83;

            switch(location) {
                // Automated Catherby Logic:
                case "Catherby": 
                    if (hasNexus) return "PoH Nexus";
                    if (lunar && mag >= 87) return "Lunar Spell";
                    return "Camelot Tele + Run East";
                
                case "North Ardougne": return ardyHard ? "Ardougne Cloak 3/4" : (hasJbox ? "Skills Necklace (Fish Guild)" : "Ardougne Tele");
                case "South Falador": return lumHard ? "Explorer's Ring 3/4" : "Falador Tele";
                case "Farming Guild": return hasJbox ? "Jewelry Box (Skills)" : "Fairy Ring (CIR)";
                case "Weiss": return hasNexus ? "PoH Nexus (Weiss)" : "Icy Basalt";
                case "Troll Stronghold": return hasNexus ? "PoH Nexus (Stronghold)" : "Stony Basalt";
                case "Harmony": return (mag >= 65 && lunar) ? "Harmony Tele" : "Ectophial + Run";
                case "Lumbridge": return hasNexus ? "PoH Nexus (Lumbridge)" : "Lumbridge Tele";
                case "Varrock": return hasNexus ? "PoH Nexus (Varrock)" : "Varrock Tele";
                case "Falador": return hasNexus ? "PoH Nexus (Falador)" : "Falador Tele";
                case "Gnome Stronghold": return hasSpiritTree ? "PoH Spirit Tree" : ((mag >= 69 && lunar) ? "Royal Seed Pod" : "Royal Seed Pod");
                case "Tree Gnome Village": return hasSpiritTree ? "PoH Spirit Tree" : "Spirit Tree (Stronghold) -> Village";
                case "Brimhaven": return hasSpiritTree ? "PoH Spirit Tree" : "House Tele (Brimhaven)";
                case "Lletya": return elf ? "Teleport Crystal" : "Running (Not Recommended)";
                case "Prifddinas": return (elf && hasSpiritTree) ? "PoH Spirit Tree (Prif)" : "Teleport Crystal";
                case "Auburnvale": return "Civitas Tele / Quetzal";
                case "Great Conch": return "Fairy Ring (CLQ)";
                case "Anglers' Retreat": return "Sailing (from Civitas)";
                default: return "Teleport";
            }
        }

        // --- ROUTE & INVENTORY ---
        function generateTreeRoute() {
            const lvl = userStats.farming;
            const r = [];
            const hasAngler = document.getElementById('check-angler').checked;

            if (lvl >= 15) {
                r.push({ header: "PHASE 1: MAJOR HUBS" });
                r.push({ location: "Gnome Stronghold (Wood)", teleport: getSmartTele("Gnome Stronghold"), type: "Wood", desc: "Run SW from Spirit Tree." });
                if (lvl >= 27) r.push({ location: "Gnome Stronghold (Fruit)", teleport: "Run East", type: "Fruit", desc: "Run East." });

                r.push({ location: "Farming Guild (Wood)", teleport: getSmartTele("Farming Guild"), type: "Wood", desc: "Central patch." });
                if (lvl >= 27) r.push({ location: "Farming Guild (Fruit)", teleport: "Run", type: "Fruit", desc: "East Wing." });
                if (lvl >= 85) r.push({ location: "Farming Guild (Celastrus)", teleport: "Run", type: "Celastrus", desc: "West Wing." });
                if (lvl >= 90) r.push({ location: "Farming Guild (Redwood)", teleport: "Run", type: "Redwood", desc: "West Wing." });

                if (lvl >= 72) {
                    r.push({ location: "Kastori (Calquat)", teleport: "Quetzal Whistle", type: "Calquat", desc: "Run to patch." });
                    if (lvl >= 27) r.push({ location: "Kastori (Fruit)", teleport: "Run", type: "Fruit", desc: "Do Fruit tree now." });
                }
            }

            if (lvl >= 15) {
                r.push({ header: "PHASE 2: ISOLATED PATCHES" });
                r.push({ location: "Lumbridge", teleport: getSmartTele("Lumbridge"), type: "Wood", desc: "Behind castle." });
                r.push({ location: "Varrock", teleport: getSmartTele("Varrock"), type: "Wood", desc: "Castle park." });
                r.push({ location: "Falador", teleport: getSmartTele("Falador"), type: "Wood", desc: "Park." });
                r.push({ location: "Taverley", teleport: "Run North", type: "Wood", desc: "From Falador Park." });
                r.push({ location: "Auburnvale", teleport: "Civitas Tele / Quetzal", type: "Wood", desc: "Varlamore." });

                if (lvl >= 27) {
                    r.push({ location: "Tree Gnome Village", teleport: getSmartTele("Tree Gnome Village"), type: "Fruit", desc: "Follow Elkoy." });
                    r.push({ location: "Brimhaven", teleport: getSmartTele("Brimhaven"), type: "Fruit", desc: "North." });
                    r.push({ location: "Catherby", teleport: getSmartTele("Catherby"), type: "Fruit", desc: "Run East." });
                    if (document.getElementById('check-elf').checked) r.push({ location: "Lletya", teleport: getSmartTele("Lletya"), type: "Fruit", desc: "Run East/Down." });
                    if (lvl < 72) r.push({ location: "Kastori", teleport: "Quetzal Whistle", type: "Fruit", desc: "Varlamore." });
                }

                if (lvl >= 72) {
                    r.push({ location: "Tai Bwo Wannai", teleport: "Scroll / Spirit Tree", type: "Calquat", desc: "Standard." });
                    r.push({ location: "Great Conch", teleport: "Fairy Ring (CLQ)", type: "Calquat", desc: "Run SE." });
                }

                if (lvl >= 35) {
                    r.push({ header: "PHASE 3: HARDWOODS" });
                    r.push({ location: "Fossil Island (x3)", teleport: "Digsite Pendant", type: "Hardwood", desc: "Verdant Valley." });
                    r.push({ location: "Avium Savannah", teleport: "Quetzal Whistle", type: "Hardwood", desc: "Hunter Guild South." });
                    if (hasAngler) r.push({ location: "Anglers' Retreat", teleport: "Sailing (from Civitas)", type: "Hardwood", desc: "Run West." });
                }
            }
            return r;
        }

        function generatePhase1Inventory() {
            const list = [{ name: "Spade" }, { name: "Coins" }, { name: "House Teleport" }];
            const lvl = userStats.farming;
            const wood = TREES.wood.find(t => lvl >= t.lvl);
            
            if(wood && lvl >= 15) {
                list.push({ name: `${wood.name} Saplings (7)` });
                list.push({ name: `Pay: ${wood.payQty * 7} ${wood.payItem}` });
            }

            // Hub Fruits
            let extraFruit = 2; // Stronghold + Guild
            let hubNote = "Stronghold & Guild";
            if (lvl >= 72) { extraFruit += 1; hubNote = "Hubs & Kastori"; }

            const bestFruit = TREES.fruit.find(t => lvl >= t.lvl);
            if(bestFruit && lvl >= 27) {
                list.push({ name: `${bestFruit.name} Saplings (${extraFruit})` });
                list.push({ name: `Pay: ${bestFruit.payQty * extraFruit} ${bestFruit.payItem} (${hubNote})` });
            }

            if (lvl >= 72) {
                const cal = TREES.calquat[0];
                list.push({ name: `Calquat Saplings (3)` });
                list.push({ name: `Pay: ${cal.payQty * 3} ${cal.payItem}` });
            }

            if (lvl >= 85) list.push({ name: "Celastrus Sapling (1)" });
            if (lvl >= 90) list.push({ name: "Redwood Sapling (1)" });

            return list;
        }

        function generatePhase2Inventory() {
            const list = [{ name: "Spade" }, { name: "Digsite Pendant" }];
            const lvl = userStats.farming;
            const hasAngler = document.getElementById('check-angler').checked;

            if (document.getElementById('check-elf').checked) list.push({ name: "Crystal Teleport" });

            let remainingFruit = 5;
            if (lvl >= 72) remainingFruit = 4;

            const bestFruit = TREES.fruit.find(t => lvl >= t.lvl);
            if(bestFruit && lvl >= 27) {
                list.push({ name: `${bestFruit.name} Saplings (${remainingFruit})` });
                list.push({ name: `Pay: ${bestFruit.payQty * remainingFruit} ${bestFruit.payItem}` });
            }

            if (lvl >= 35) {
                let hardCount = 4; 
                if (hasAngler) hardCount = 5;
                const bestHard = TREES.hardwood.find(t => lvl >= t.lvl);
                if(bestHard) {
                    list.push({ name: `${bestHard.name} Saplings (${hardCount})` });
                    list.push({ name: `Pay: ${bestHard.payQty * hardCount} ${bestHard.payItem}` });
                }
            }
            return list;
        }

        // --- RENDERERS ---
        function updateUI() { switchMode(currentMode); updateStats(); }
        function updateStatsFromSlider() {
            userStats.farming = parseInt(document.getElementById('level-slider').value);
            document.getElementById('stat-farm').innerText = userStats.farming;
            updateUI();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if(mode === 'herb') document.getElementById('btn-herb').classList.add('active');
            if(mode === 'tree') document.getElementById('btn-tree').classList.add('active');
            if(mode === 'reference') document.getElementById('btn-ref').classList.add('active');

            const invBox = document.getElementById('inv-box');
            const routeCont = document.getElementById('route-container');
            const statsPanel = document.getElementById('stats-panel');

            // Reset/Clear Route container
            routeCont.innerHTML = '';

            if (mode === 'reference') {
                statsPanel.classList.add('hidden');
                routeCont.classList.remove('border-l-4'); 
                
                // Clear styling and set content for reference mode
                invBox.className = ''; 
                invBox.innerHTML = `
                    <div class="lobster-container">
                        <a href="https://lobsterpotclan.com/" target="_blank" title="Visit Lobster Pot Clan" class="lobster">
                            ü¶û
                        </a>
                    </div>
                `;
                
                renderReference(routeCont);
            } else {
                // Restore UI elements for Herb/Tree mode
                statsPanel.classList.remove('hidden');
                routeCont.classList.add('border-l-4');

                const existingContainer = document.getElementById('inventory-container');
                if (!existingContainer) {
                    invBox.className = "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#3d5c25] dark:border-green-500 transition-colors";
                    invBox.innerHTML = `
                        <h2 class="text-2xl font-bold mb-3 text-[#3d5c25] dark:text-green-400" id="prep-title">Inventory</h2>
                        <div id="inventory-container" class="space-y-4"></div>
                    `;
                }
                
                const invContainer = document.getElementById('inventory-container');
                invContainer.innerHTML = ''; // Clear lists

                if (mode === 'herb') {
                    document.getElementById('prep-title').innerText = "Herb Inventory";
                    document.getElementById('route-title').innerText = "Herb Route";
                    
                    const bestHerb = HERBS.find(h => userStats.farming >= h.lvl) || HERBS[HERBS.length-1];
                    const herbInv = [
                        { name: "Magic Secateurs" }, { name: "Spade" }, { name: "Seed Dibber" },
                        { name: "Bottomless Bucket" }, { name: `${bestHerb.name} Seeds (9)` }
                    ];
                    renderList(herbInv, invContainer);
                    
                    const hRoute = [
                        { location: "Troll Stronghold", teleport: getSmartTele("Troll Stronghold"), type: "Disease Free", desc: "Roof patch." },
                        { location: "Weiss", teleport: getSmartTele("Weiss"), type: "Disease Free", desc: "West." },
                        { location: "Farming Guild", teleport: getSmartTele("Farming Guild"), type: "High Yield", desc: "West wing." },
                        { location: "Catherby", teleport: getSmartTele("Catherby"), type: "Standard", desc: "East." },
                        { location: "North Ardougne", teleport: getSmartTele("North Ardougne"), type: "Standard", desc: "North." },
                        { location: "South Falador", teleport: getSmartTele("South Falador"), type: "Standard", desc: "NW." },
                        { location: "Port Phasmatys", teleport: "Ectophial", type: "Standard", desc: "West." },
                        { location: "Hosidius", teleport: "Xeric's Talisman", type: "Disease Free", desc: "South." },
                        { location: "Civitas illa Fortis", teleport: "Civitas Tele / Quetzal", type: "Standard", desc: "SE." },
                        { location: "Harmony Island", teleport: getSmartTele("Harmony"), type: "Elite", desc: "South." }
                    ];
                    renderRoute(hRoute, routeCont);

                } else if (mode === 'tree') {
                    document.getElementById('prep-title').innerText = "Tree Inventory";
                    document.getElementById('route-title').innerText = "Tree Route";
                    
                    const p1Label = document.createElement('h3');
                    p1Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-0 text-sm uppercase tracking-wide";
                    p1Label.innerText = "Phase 1";
                    invContainer.appendChild(p1Label);
                    const list1Div = document.createElement('div');
                    list1Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 mb-4 space-y-2";
                    renderList(generatePhase1Inventory(), list1Div);
                    invContainer.appendChild(list1Div);

                    const p2Label = document.createElement('h3');
                    p2Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-2 text-sm uppercase tracking-wide";
                    p2Label.innerText = "Phase 2";
                    invContainer.appendChild(p2Label);
                    const list2Div = document.createElement('div');
                    list2Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 space-y-2";
                    renderList(generatePhase2Inventory(), list2Div);
                    invContainer.appendChild(list2Div);

                    renderRoute(generateTreeRoute(), routeCont);
                }
            }
        }

        // --- FETCH STATS ---
        function handleEnter(e) { if(e.key === 'Enter') fetchStats(); }
        async function fetchStats() {
            const rsn = document.getElementById('rsn-input').value;
            const loader = document.getElementById('api-loader');
            const fetchText = document.getElementById('fetch-text');
            if(!rsn) return;

            loader.style.display = 'block';
            fetchText.style.display = 'none';
            try {
                const response = await fetch(`https://api.wiseoldman.net/v2/players/${rsn}`);
                if (!response.ok) throw new Error('Player not found');
                const data = await response.json();
                userStats.farming = data.latestSnapshot.data.skills.farming.level;
                userStats.magic = data.latestSnapshot.data.skills.magic.level;
                userStats.construction = data.latestSnapshot.data.skills.construction.level;
                document.getElementById('stat-farm').innerText = userStats.farming;
                document.getElementById('stat-magic').innerText = userStats.magic;
                document.getElementById('stat-con').innerText = userStats.construction;
                document.getElementById('level-slider').value = userStats.farming;
                updateUI();
            } catch (err) { alert("Could not fetch stats."); } finally { loader.style.display = 'none'; fetchText.style.display = 'inline'; }
        }

        function renderList(items, container) {
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'interactive-row flex items-center p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 shadow-sm';
                row.innerHTML = `<span class="text-sm font-semibold text-gray-800 dark:text-gray-100">${item.name}</span>`;
                row.onclick = () => {
                    row.classList.toggle('completed');
                    // NO CHECK COMPLETION for Inventory
                };
                container.appendChild(row);
            });
        }

        function renderRoute(data, container) {
            container.innerHTML = '';
            let stepCount = 0;
            data.forEach((step, index) => {
                if (step.header) {
                    const header = document.createElement('div');
                    header.className = "phase-header text-[#78350f] bg-[#fef3c7] border-[#d97706] dark:text-amber-100 dark:bg-amber-900/40 dark:border-amber-700";
                    header.innerText = step.header;
                    container.appendChild(header);
                    return;
                }
                stepCount++; 
                const stepEl = document.createElement('div');
                stepEl.className = "mb-10 ml-6 group";
                
                // Add route-step marker class
                const content = `
                    <div class="interactive-row route-step relative flex flex-col sm:flex-row items-start sm:items-center bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm p-4">
                        <div class="flex-grow">
                            <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900 dark:text-gray-100">${step.location}</h3>
                            <div class="mb-2 text-sm text-gray-500 dark:text-gray-400">Via: ${step.teleport}</div>
                            <p class="mb-2 text-gray-600 dark:text-gray-300 text-sm">${step.desc}</p>
                        </div>
                    </div>`;
                stepEl.innerHTML = `<span class="absolute flex items-center justify-center w-8 h-8 bg-white dark:bg-gray-600 rounded-full -left-4 border border-gray-300 dark:border-gray-500 font-bold text-gray-500 dark:text-gray-300">${stepCount}</span>` + content;
                container.appendChild(stepEl);
                const rowDiv = stepEl.querySelector('.interactive-row');
                rowDiv.addEventListener('click', () => {
                    rowDiv.classList.toggle('completed');
                    checkCompletion();
                });
            });
        }

        // --- FIREWORKS LOGIC ---
        function checkCompletion() {
            // ONLY check items with 'route-step' class
            const allItems = document.querySelectorAll('.route-step');
            if (allItems.length === 0) return;
            
            const completedItems = document.querySelectorAll('.route-step.completed');
            if (completedItems.length === allItems.length) {
                // FIREWORKS!
                const duration = 3000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

                const randomInRange = (min, max) => Math.random() * (max - min) + min;

                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    const particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            }
        }

        function renderReference(route) {
            route.innerHTML = '';
            const createSection = (title, data) => {
                const div = document.createElement('div');
                div.className = "mb-8";
                div.innerHTML = `<h3 class="text-xl font-bold text-[#3d5c25] dark:text-green-400 mb-2">${title}</h3>`;
                const table = document.createElement('table');
                table.className = "ref-table text-gray-800 dark:text-gray-200";
                table.innerHTML = `<thead><tr><th>Level</th><th>Tree</th><th>Payment</th></tr></thead>`;
                const tbody = document.createElement('tbody');
                const sortedData = [...data].sort((a,b) => a.lvl - b.lvl);
                sortedData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "dark:border-gray-700";
                    tr.innerHTML = `<td>${item.lvl}</td><td>${item.name}</td><td>${item.payQty} ${item.payItem}</td>`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                div.appendChild(table);
                route.appendChild(div);
            };
            createSection("üå≤ Wood Trees", TREES.wood);
            createSection("üçé Fruit Trees", TREES.fruit);
            createSection("üå¥ Hardwood & Special", [...TREES.hardwood, ...TREES.calquat, ...TREES.celastrus, ...TREES.redwood]);
        }

        function updateStats() {
            let total = 0;
            if (currentMode === 'herb') {
                const base = userStats.farming >= 85 ? 85 : 50; 
                total = base * 9 * 150; 
            } else {
                const lvl = userStats.farming;
                const wood = TREES.wood.find(t => lvl >= t.lvl);
                if(wood) total += wood.xp * 7;
                
                const fruit = TREES.fruit.find(t => lvl >= t.lvl);
                if(fruit) total += fruit.xp * 7;

                const hard = TREES.hardwood.find(t => lvl >= t.lvl);
                if(hard) total += hard.xp * 5;

                const cal = TREES.calquat[0];
                if(lvl >= 72) total += cal.xp * 3;

                const cel = TREES.celastrus[0];
                if(lvl >= 85) total += cel.xp;

                const red = TREES.redwood[0];
                if(lvl >= 90) total += red.xp;
            }
            document.getElementById('xp-display').innerText = total.toLocaleString() + " XP";
        }

        function toggleTheme(toggle = true) {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            let isDark = html.classList.contains('dark');
            if(toggle) {
                isDark = !isDark;
                isDark ? html.classList.add('dark') : html.classList.remove('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            } else {
                const saved = localStorage.getItem('theme');
                if(saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    html.classList.add('dark'); isDark = true;
                }
            }
            icon.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        rotateQuotes();
        toggleTheme(false);
        updateUI(); 
    </script>
</body>
</html>
