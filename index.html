<!-- Chosen Palette: OSRS Natural (Warm Neutrals, Earthy Greens, UI Browns) + Dark Mode -->
<!-- Application Structure Plan: 
    - UPDATE: Replaced Construction Level logic with "Ornate Jewelry Box" checkbox.
    - LOGIC: Spirit Tree availability calculated by Farming Level (83=Guild, 91=Brimhaven).
    - LOGIC: Falador/Guild teleports now prioritize Ornate Jewelry Box.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barker's Farm Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cinzel:wght@700&display=swap');

        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        h1, h2, h3, h4 { font-family: 'Cinzel', serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .mode-btn { transition: all 0.2s; border: 2px solid #3d5c25; }
        .mode-btn.active { background-color: #3d5c25; color: white; border-color: #2e461b; }
        .dark .mode-btn { border-color: #86efac; color: #86efac; background-color: transparent; }
        .dark .mode-btn.active { background-color: #86efac; color: #064e3b; border-color: #86efac; }

        .phase-header {
            display: flex; align-items: center; justify-content: center; margin: 2rem 0;
            font-weight: bold; font-family: 'Cinzel', serif; font-size: 1.1rem;
            padding: 10px; border-radius: 8px; border-width: 1px; letter-spacing: 0.05em;
        }

        .interactive-row { cursor: pointer; transition: all 0.2s ease; user-select: none; }
        .interactive-row.completed {
            background-color: #dcfce7 !important; border-color: #22c55e !important; opacity: 0.8;
        }
        .dark .interactive-row.completed {
            background-color: #064e3b !important; border-color: #4ade80 !important; opacity: 0.9;
        }

        .tree-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-left: 8px; display: inline-block; vertical-align: middle; }
        .badge-wood { background-color: #d1fae5; color: #065f46; } .dark .badge-wood { background-color: #064e3b; color: #a7f3d0; }
        .badge-fruit { background-color: #ffedd5; color: #9a3412; } .dark .badge-fruit { background-color: #7c2d12; color: #fdba74; }
        .badge-calquat { background-color: #fef9c3; color: #854d0e; } .dark .badge-calquat { background-color: #713f12; color: #fde047; }
        .badge-hardwood { background-color: #fee2e2; color: #991b1b; } .dark .badge-hardwood { background-color: #7f1d1d; color: #fca5a5; }
        .badge-special { background-color: #f3e8ff; color: #6b21a8; } .dark .badge-special { background-color: #581c87; color: #d8b4fe; }
        .badge-bank { background-color: #e5e7eb; color: #374151; } .dark .badge-bank { background-color: #4b5563; color: #e5e7eb; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3d5c25; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .stat-box { display: flex; flex-direction: column; align-items: center; padding: 0.5rem; border-radius: 0.5rem; }

        @keyframes dance { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg) scale(1.1); } }
        .lobster-container { display: flex; align-items: center; justify-content: center; height: 100%; min-height: 200px; }
        .lobster { font-size: 8rem; cursor: pointer; animation: dance 1s infinite ease-in-out; display: inline-block; text-decoration: none; }
        
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .ref-table th { background-color: #3d5c25; color: white; padding: 10px; text-align: left; font-weight: 600; }
        .ref-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; }
        .dark .ref-table td { border-bottom: 1px solid #4b5563; }
        .ref-table tr:nth-child(even) { background-color: #f9fafb; }
        .dark .ref-table tr:nth-child(even) { background-color: #374151; }

        /* Input styling */
        .stat-input {
            background: transparent;
            border: none;
            text-align: center;
            font-weight: bold;
            font-size: 1.125rem;
            width: 100%;
        }
        .stat-input:focus { outline: 2px solid #3d5c25; border-radius: 4px; }
    </style>
</head>
<body class="bg-[#f0f0eb] text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="absolute top-4 right-4 bg-white dark:bg-gray-700 shadow-md p-2 rounded-full hover:scale-110 transition-transform z-50" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span id="theme-icon">üåô</span>
    </button>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <header class="mb-8 text-center relative pt-8 sm:pt-0">
            <h1 class="text-4xl font-bold text-[#3e2723] dark:text-[#e7d8c9] mb-6">Barker's Farm Run</h1>
            
            <!-- INPUT SECTION -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 max-w-3xl mx-auto mb-8 border border-gray-200 dark:border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Column 1: Stats -->
                    <div>
                        <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase">Player Stats</h4>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="rsn-input" placeholder="OSRS Username" class="w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#3d5c25]" onkeypress="handleEnter(event)">
                            <button onclick="fetchStats()" class="bg-[#3d5c25] hover:bg-[#2e461b] text-white px-3 py-2 rounded font-bold transition-colors flex items-center justify-center min-w-[80px]">
                                <span id="fetch-text">Fetch</span> <div id="api-loader" class="loader ml-2"></div>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div class="stat-box bg-green-50 dark:bg-green-900/30">
                                <span class="text-gray-500 dark:text-gray-400">Farming</span>
                                <input type="number" id="stat-farm" value="99" class="stat-input text-[#3d5c25] dark:text-green-400" onchange="updateUI()">
                            </div>
                            <div class="stat-box bg-blue-50 dark:bg-blue-900/30">
                                <span class="text-gray-500 dark:text-gray-400">Magic</span>
                                <input type="number" id="stat-magic" value="99" class="stat-input text-blue-600 dark:text-blue-400" onchange="updateUI()">
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Unlocks -->
                    <div class="border-l border-gray-200 dark:border-gray-600 pl-0 md:pl-6 pt-4 md:pt-0">
                        <h4 class="text-sm font-bold text-gray-500 mb-2 uppercase">Unlock Settings</h4>
                        <div class="space-y-2 text-sm grid grid-cols-1 sm:grid-cols-2 gap-x-2">
                            <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="check-nexus" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>PoH Portal Nexus</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="check-ornate" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Ornate Jewelry Box</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="check-lunar" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Lunar Spellbook</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="check-ardy-hard" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Ardy Hard+ Diary</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="check-lum-hard" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Lum Hard+ Diary</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none"><input type="checkbox" id="check-elf" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Elf Questline</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none col-span-full"><input type="checkbox" id="check-mory-elite" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Morytania Elite Diary Complete</span></label>
                            <label class="flex items-center space-x-2 cursor-pointer select-none col-span-full"><input type="checkbox" id="check-angler" checked class="form-checkbox text-[#3d5c25] rounded" onchange="updateUI()"><span>Anglers' Retreat (51 Sailing)</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode Buttons -->
            <div class="flex justify-center flex-wrap gap-4 mb-4">
                <button onclick="switchMode('herb')" id="btn-herb" class="mode-btn active px-6 py-2 rounded-full font-bold transition-colors">üåø Herb Run</button>
                <button onclick="switchMode('tree')" id="btn-tree" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">üå≥ Tree Run</button>
                <button onclick="switchMode('reference')" id="btn-ref" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">üìò Reference</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-8">
                <div id="inv-box" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#3d5c25] dark:border-green-500 transition-colors">
                    <h2 class="text-2xl font-bold mb-3 text-[#3d5c25] dark:text-green-400" id="prep-title">Inventory</h2>
                    <div id="inventory-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- Route Main Area -->
            <div class="lg:col-span-8">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg min-h-screen transition-colors">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-[#2e3b2b] dark:text-gray-100" id="route-title">The Route</h2>
                    </div>
                    <div class="relative border-l-4 border-gray-200 dark:border-gray-700 ml-4 space-y-12" id="route-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        let userStats = { farming: 99, magic: 99 };
        let currentMode = 'herb';

        // --- CONSTANTS ---
        const TREES = {
            wood: [ { lvl: 75, name: "Magic", payQty: 25, payItem: "Coconuts" }, { lvl: 60, name: "Yew", payQty: 10, payItem: "Cactus Spines" }, { lvl: 45, name: "Maple", payQty: 1, payItem: "Basket of Oranges" }, { lvl: 15, name: "Oak", payQty: 1, payItem: "Basket of Tomatoes" } ],
            fruit: [ { lvl: 81, name: "Dragonfruit", payQty: 15, payItem: "Coconut" }, { lvl: 68, name: "Palm", payQty: 15, payItem: "Papaya Fruit" }, { lvl: 57, name: "Papaya", payQty: 10, payItem: "Pineapple" }, { lvl: 27, name: "Apple", payQty: 9, payItem: "Sweetcorn" } ],
            hardwood: [ { lvl: 55, name: "Mahogany", payQty: 25, payItem: "Yanillian Hops" }, { lvl: 35, name: "Teak", payQty: 15, payItem: "Limpwurt Roots" } ],
            calquat: [ { lvl: 72, name: "Calquat", payQty: 8, payItem: "Poison Ivy Berries" } ],
            celastrus: [ { lvl: 85, name: "Celastrus", payQty: 8, payItem: "Potato Cactus" } ],
            redwood: [ { lvl: 90, name: "Redwood", payQty: 6, payItem: "Dragonfruit" } ]
        };

        const HERBS = [ { lvl: 85, name: "Torstol" }, { lvl: 32, name: "Ranarr" }, { lvl: 9, name: "Guam" } ];

        // --- SMART TELEPORT ENGINE ---
        function getSmartTele(location) {
            const mag = userStats.magic;
            const farm = userStats.farming;
            
            const lunar = document.getElementById('check-lunar').checked;
            const ardyHard = document.getElementById('check-ardy-hard').checked; 
            const lumHard = document.getElementById('check-lum-hard').checked; 
            const elf = document.getElementById('check-elf').checked;
            const hasNexus = document.getElementById('check-nexus').checked; 
            const hasOrnate = document.getElementById('check-ornate').checked;

            // Spirit Tree Availability Logic
            // Level 83+: 1 Planted Tree (Assume Guild).
            // Level 91+: 2 Planted Trees (Assume Guild + Brimhaven).
            // Level 99: Unlimited.
            const canUseGuildTree = farm >= 83;
            const canUseBrimTree = farm >= 91;

            switch(location) {
                // HERBS
                case "Catherby": 
                    if (hasNexus && mag >= 87) return { text: "PoH Nexus (Catherby)", items: ["House Teleport"] };
                    if (lunar && mag >= 87) return { text: "Lunar Spell (Catherby)", items: ["Runes (Catherby Tele)"] };
                    return { text: "Catherby Teleport Tab", items: ["Catherby Teleport"] };
                
                case "North Ardougne": 
                    if (ardyHard) return { text: "Ardougne Cloak 3/4", items: ["Ardougne Cloak"] };
                    if (hasOrnate) return { text: "Jewelry Box (Fish Guild)", items: ["House Teleport"] };
                    if (mag >= 51) return { text: "Ardougne Teleport", items: ["Runes (Ardy)"] };
                    return { text: "Ardougne Teleport Tab", items: ["Ardougne Teleport"] };

                case "South Falador": 
                    if (lumHard) return { text: "Explorer's Ring 3/4", items: ["Explorer's Ring"] };
                    if (mag >= 37) return { text: "Falador Teleport", items: ["Runes (Falador)"] };
                    return { text: "Falador Teleport Tab", items: ["Falador Teleport"] };

                case "Farming Guild": 
                    if (hasOrnate) return { text: "Jewelry Box (Skills)", items: ["House Teleport"] }; 
                    return { text: "Skills Necklace", items: ["Skills Necklace"] }; 

                case "Weiss": 
                    if (hasNexus) return { text: "PoH Nexus (Weiss)", items: ["House Teleport"] };
                    return { text: "Icy Basalt", items: ["Icy Basalt"] };

                case "Troll Stronghold": 
                    if (hasNexus) return { text: "PoH Nexus (Stronghold)", items: ["House Teleport"] };
                    return { text: "Stony Basalt", items: ["Stony Basalt"] };

                case "Harmony": 
                    if (lunar && mag >= 65) return { text: "Harmony Is. Teleport", items: ["Runes (Harmony)"] };
                    return { text: "Harmony Tab / Ectophial", items: ["Harmony Tab"] };

                case "Port Phasmatys": return { text: "Ectophial", items: ["Ectophial"] };
                case "Hosidius": return { text: "Xeric's Talisman", items: ["Xeric's Talisman (if not mounted)"] };
                case "Civitas": return (mag >= 20) ? { text: "Civitas Teleport (Spell/Tab)", items: ["Civitas Teleport"] } : { text: "Quetzal Whistle", items: ["Quetzal Whistle"] };

                // TREES
                case "Lumbridge": 
                    if (hasNexus && mag >= 31) return { text: "PoH Nexus (Lumbridge)", items: ["House Teleport"] };
                    if (mag >= 31) return { text: "Lumbridge Teleport", items: ["Runes (Lumb)"] };
                    return { text: "Lumbridge Tab", items: ["Lumbridge Teleport"] };
                case "Varrock": 
                    if (hasNexus && mag >= 25) return { text: "PoH Nexus (Varrock)", items: ["House Teleport"] };
                    if (mag >= 25) return { text: "Varrock Teleport", items: ["Runes (Varrock)"] };
                    return { text: "Varrock Tab", items: ["Varrock Teleport"] };
                
                case "Falador": 
                    if (hasOrnate) return { text: "Jewelry Box (Falador Park)", items: ["House Teleport"] };
                    if (hasNexus && mag >= 37) return { text: "PoH Nexus (Falador)", items: ["House Teleport"] };
                    if (mag >= 37) return { text: "Falador Teleport", items: ["Runes (Falador)"] };
                    return { text: "Falador Tab", items: ["Falador Teleport"] };
                
                case "Gnome Stronghold": 
                    // Always has Spirit Tree
                    if (hasNexus) return { text: "PoH Spirit Tree", items: ["House Teleport"] };
                    return { text: "Royal Seed Pod", items: ["Royal Seed Pod"] };

                case "Tree Gnome Village": 
                    if (hasNexus) return { text: "PoH Spirit Tree", items: ["House Teleport"] };
                    return { text: "Spirit Tree (Stronghold) -> Village", items: [] };

                case "Brimhaven": 
                    if (hasNexus && canUseBrimTree) return { text: "PoH Spirit Tree", items: ["House Teleport"] };
                    return { text: "Brimhaven Tab / Redirect", items: ["Brimhaven Teleport"] };
                
                case "Lletya": return elf ? { text: "Teleport Crystal", items: ["Teleport Crystal"] } : { text: "Running (Not Recommended)", items: [] };
                case "Prifddinas": return (elf && hasNexus) ? { text: "PoH Spirit Tree (Prif)", items: ["House Teleport"] } : { text: "Teleport Crystal", items: ["Teleport Crystal"] };
                
                case "Auburnvale": return { text: "Fairy Ring (AIS)", items: ["Dramen Staff"] };
                case "Great Conch": return { text: "Fairy Ring (CJQ)", items: ["Dramen Staff"] };
                case "Anglers' Retreat": return { text: "Sailing (from Civitas)", items: ["Civitas Teleport"] };
                case "Tai Bwo Wannai": return { text: "Master Scroll Book", items: ["Master Scroll Book"] };

                default: return { text: "Teleport", items: [] };
            }
        }

        // --- ROUTE GENERATION ---
        
        function getHerbRoute() {
            const route = [];
            route.push({ loc: "Troll Stronghold", type: "Herb", dir: "Run to roof patch." });
            route.push({ loc: "Weiss", type: "Herb", dir: "Run West." });
            route.push({ loc: "Catherby", type: "Herb", dir: "Run East." });
            route.push({ loc: "North Ardougne", type: "Herb", dir: "Run North." });
            route.push({ loc: "South Falador", type: "Herb", dir: "Run NW." });
            route.push({ loc: "Port Phasmatys", type: "Herb", dir: "Run West." });
            route.push({ loc: "Hosidius", type: "Herb", dir: "Run South." });
            route.push({ loc: "Civitas illa Fortis", type: "Herb", dir: "Tele -> Quetzal to Hunter Guild -> Run North." });
            if (document.getElementById('check-mory-elite').checked) {
                route.push({ loc: "Harmony", type: "Herb", dir: "Run South." });
            }
            route.push({ loc: "Farming Guild", type: "Herb", dir: "Southwest Wing. BANK HERE." });
            return route;
        }

        function getTreeRoutePhase1(lvl) {
            const r = [];
            if (lvl >= 15) {
                // START GUILD
                r.push({ loc: "Farming Guild", type: "Wood", dir: "Southwest Wing." });
                if (lvl >= 27) r.push({ loc: "Farming Guild", type: "Fruit", dir: "North Wing." });
                if (lvl >= 85) r.push({ loc: "Farming Guild", type: "Special", dir: "Celastrus (West Wing)." });
                if (lvl >= 90) r.push({ loc: "Farming Guild", type: "Special", dir: "Redwood (West Wing)." });

                // GNOME STRONGHOLD
                r.push({ loc: "Gnome Stronghold", type: "Fruit", dir: "Run East from Spirit Tree." });
                r.push({ loc: "Gnome Stronghold", type: "Wood", dir: "Run SW from Spirit Tree." });
                
                // STANDARD WOODS
                r.push({ loc: "Lumbridge", type: "Wood", dir: "Behind castle." });
                r.push({ loc: "Varrock", type: "Wood", dir: "Castle park." });
                r.push({ loc: "Falador", type: "Wood", dir: "Park." });
                r.push({ loc: "Taverley", type: "Wood", dir: "From Falador Park." });
                r.push({ loc: "Auburnvale", type: "Wood", dir: "Varlamore." });

                // CALQUAT + KASTORI
                if (lvl >= 72) {
                    r.push({ loc: "Tai Bwo Wannai", type: "Calquat", dir: "Standard." });
                    r.push({ loc: "Great Conch", type: "Calquat", dir: "Run SE." });
                    r.push({ loc: "Kastori", type: "Calquat", dir: "Run to patch." });
                    if (lvl >= 27) r.push({ loc: "Kastori", type: "Fruit", dir: "Do Fruit tree now." });
                }
            }
            return r;
        }

        function getTreeRoutePhase2(lvl) {
            const r = [];
            // Banking Intermission
            if (lvl >= 27 || lvl >= 35) {
                r.push({ loc: "Bank", type: "Bank", dir: "BANKING INTERMISSION: Withdraw Phase 2 Items." });
            }

            // FRUITS + HARDWOODS
            if (lvl >= 27) {
                r.push({ loc: "Tree Gnome Village", type: "Fruit", dir: "Follow Elkoy." });
                r.push({ loc: "Brimhaven", type: "Fruit", dir: "North." });
                r.push({ loc: "Catherby", type: "Fruit", dir: "Run East." });
                if (document.getElementById('check-elf').checked) r.push({ loc: "Lletya", type: "Fruit", dir: "Run East/Down." });
                if (lvl < 72) r.push({ loc: "Kastori", type: "Fruit", dir: "Varlamore." });
            }

            if (lvl >= 35) {
                r.push({ loc: "Fossil Island", type: "Hardwood", dir: "3 Patches (Verdant Valley)." });
                r.push({ loc: "Avium Savannah", type: "Hardwood", dir: "Hunter Guild South." });
                if (document.getElementById('check-angler').checked) {
                    r.push({ loc: "Anglers' Retreat", type: "Hardwood", dir: "Run West." });
                }
            }
            return r;
        }

        // --- INVENTORY BUILDER ---
        function buildInventory(routeData, extraStaticItems = []) {
            const items = new Set([...extraStaticItems]);
            const lvl = userStats.farming;
            const hasLunar = document.getElementById('check-lunar').checked;

            routeData.forEach(step => {
                if(!step.loc || step.loc === "Bank") return; 
                const t = getSmartTele(step.loc);
                
                // Special check for Dramen Staff -> Lunar Staff
                t.items.forEach(i => {
                    if (i === "Dramen Staff" && hasLunar) items.add("Lunar Staff");
                    else items.add(i);
                });
            });

            // Logic Specifics
            if (routeData.some(s => s.loc === "Tai Bwo Wannai")) items.add("Master Scroll Book");

            const counts = { wood:0, fruit:0, cal:0, hard:0, cel:0, red:0 };
            routeData.forEach(step => {
                if(step.type === "Wood") counts.wood++;
                if(step.type === "Fruit") counts.fruit++;
                if(step.type === "Calquat") counts.cal++;
                if(step.type === "Hardwood") {
                    if(step.loc.includes("Fossil")) counts.hard += 3; 
                    else counts.hard++;
                }
                if(step.type === "Special" && step.dir.includes("Celastrus")) counts.cel++;
                if(step.type === "Special" && step.dir.includes("Redwood")) counts.red++;
            });

            const w = TREES.wood.find(t=>lvl>=t.lvl);
            if(counts.wood && w) { items.add(`${w.name} Saplings (${counts.wood})`); items.add(`Pay: ${counts.wood * w.payQty} ${w.payItem} (Wood)`); }
            
            const f = TREES.fruit.find(t=>lvl>=t.lvl);
            if(counts.fruit && f) { items.add(`${f.name} Saplings (${counts.fruit})`); items.add(`Pay: ${counts.fruit * f.payQty} ${f.payItem} (Fruit)`); }

            const h = TREES.hardwood.find(t=>lvl>=t.lvl);
            if(counts.hard && h) { items.add(`${h.name} Saplings (${counts.hard})`); items.add(`Pay: ${counts.hard * h.payQty} ${h.payItem} (Hard)`); }

            if(counts.cal) { items.add(`Calquat Saplings (${counts.cal})`); items.add(`Pay: ${counts.cal * TREES.calquat[0].payQty} ${TREES.calquat[0].payItem}`); }
            if(counts.cel) { items.add(`Celastrus Sapling`); items.add(`Pay: ${TREES.celastrus[0].payQty} ${TREES.celastrus[0].payItem}`); }
            if(counts.red) { items.add(`Redwood Sapling`); items.add(`Pay: ${TREES.redwood[0].payQty} ${TREES.redwood[0].payItem}`); }

            return Array.from(items).map(name => ({ name }));
        }

        function buildHerbInventory(routeData) {
            const items = new Set(["Magic Secateurs", "Spade", "Seed Dibber", "Bottomless Bucket"]);
            items.add("Ectophial"); items.add("Explorer's Ring"); items.add("Ardougne Cloak"); items.add("Xeric's Talisman (if not mounted)");

            routeData.forEach(step => {
                const t = getSmartTele(step.loc);
                t.items.forEach(i => items.add(i));
            });

            const h = HERBS.find(t=>userStats.farming>=t.lvl) || HERBS[HERBS.length-1];
            items.add(`${h.name} Seeds (${routeData.length})`);
            return Array.from(items).map(name => ({ name }));
        }

        // --- RENDERERS ---
        function updateUI() { switchMode(currentMode); }
        function updateStatsFromSlider() {
            // Read from Input Fields (Manual)
            userStats.farming = parseInt(document.getElementById('stat-farm').value) || 1;
            userStats.magic = parseInt(document.getElementById('stat-magic').value) || 1;
            updateUI();
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if(mode === 'herb') document.getElementById('btn-herb').classList.add('active');
            if(mode === 'tree') document.getElementById('btn-tree').classList.add('active');
            if(mode === 'reference') document.getElementById('btn-ref').classList.add('active');

            const invBox = document.getElementById('inv-box');
            const routeCont = document.getElementById('route-container');
            routeCont.innerHTML = '';

            if (mode === 'reference') {
                routeCont.classList.remove('border-l-4'); 
                invBox.className = ''; 
                invBox.innerHTML = `<div class="lobster-container"><a href="https://lobsterpotclan.com/" target="_blank" title="Visit Lobster Pot Clan" class="lobster">ü¶û</a></div>`;
                renderReference(routeCont);
            } else {
                routeCont.classList.add('border-l-4');
                const existingContainer = document.getElementById('inventory-container');
                if (!existingContainer) {
                    invBox.className = "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#3d5c25] dark:border-green-500 transition-colors sticky top-8";
                    invBox.innerHTML = `
                        <h2 class="text-2xl font-bold mb-3 text-[#3d5c25] dark:text-green-400" id="prep-title">Inventory</h2>
                        <div id="inventory-container" class="space-y-4"></div>
                    `;
                }
                const invContainer = document.getElementById('inventory-container');
                invContainer.innerHTML = '';
                const lvl = userStats.farming;

                if (mode === 'herb') {
                    document.getElementById('prep-title').innerText = "Herb Inventory";
                    const route = getHerbRoute();
                    const inventory = buildHerbInventory(route);
                    renderList(inventory, invContainer);
                    renderRoute(route, routeCont);
                } else if (mode === 'tree') {
                    document.getElementById('prep-title').innerText = "Tree Inventory";
                    
                    const p1Route = getTreeRoutePhase1(lvl);
                    const p1Inv = buildInventory(p1Route, ["Spade", "Coins"]); 

                    const p1Label = document.createElement('h3');
                    p1Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-0 text-sm uppercase tracking-wide";
                    p1Label.innerText = "Phase 1";
                    invContainer.appendChild(p1Label);
                    const list1Div = document.createElement('div');
                    list1Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 mb-4 space-y-2";
                    renderList(p1Inv, list1Div);
                    invContainer.appendChild(list1Div);

                    const p2Route = getTreeRoutePhase2(lvl);
                    if (p2Route.length > 0) {
                        const p2Inv = buildInventory(p2Route, ["Spade"]); 
                        const p2Label = document.createElement('h3');
                        p2Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-2 text-sm uppercase tracking-wide";
                        p2Label.innerText = "Phase 2";
                        invContainer.appendChild(p2Label);
                        const list2Div = document.createElement('div');
                        list2Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 space-y-2";
                        renderList(p2Inv, list2Div);
                        invContainer.appendChild(list2Div);
                    }

                    const combinedRoute = [];
                    if (p1Route.length) {
                        p1Route.forEach(s => combinedRoute.push(s));
                    }
                    if (p2Route.length) {
                        p2Route.forEach(s => combinedRoute.push(s));
                    }
                    renderRoute(combinedRoute, routeCont);
                }
            }
        }

        function handleEnter(e) { if(e.key === 'Enter') fetchStats(); }
        async function fetchStats() {
            const rsn = document.getElementById('rsn-input').value;
            const loader = document.getElementById('api-loader');
            const fetchText = document.getElementById('fetch-text');
            if(!rsn) return;
            loader.style.display = 'block';
            fetchText.style.display = 'none';
            try {
                const response = await fetch(`https://api.wiseoldman.net/v2/players/${rsn}`);
                if (!response.ok) throw new Error('Player not found');
                const data = await response.json();
                userStats.farming = data.latestSnapshot.data.skills.farming.level;
                userStats.magic = data.latestSnapshot.data.skills.magic.level;
                document.getElementById('stat-farm').value = userStats.farming;
                document.getElementById('stat-magic').value = userStats.magic;
                updateUI();
            } catch (err) { alert("Could not fetch stats."); } finally { loader.style.display = 'none'; fetchText.style.display = 'inline'; }
        }

        function renderList(items, container) {
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'interactive-row flex items-center p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 shadow-sm';
                row.innerHTML = `<span class="text-sm font-semibold text-gray-800 dark:text-gray-100">${item.name}</span>`;
                row.onclick = () => {
                    row.classList.toggle('completed');
                };
                container.appendChild(row);
            });
        }

        function renderRoute(data, container) {
            container.innerHTML = '';
            let stepCount = 0;
            data.forEach((step, index) => {
                // Skip rendering explicit header items in route list if wanted, 
                // but kept for Banking Intermission clarity.
                if (step.type === 'Bank') {
                    const header = document.createElement('div');
                    header.className = "phase-header text-[#78350f] bg-[#fef3c7] border-[#d97706] dark:text-amber-100 dark:bg-amber-900/40 dark:border-amber-700 my-4";
                    header.innerText = step.dir; // Use desc for bank step text
                    container.appendChild(header);
                    return;
                }

                stepCount++; 
                const stepEl = document.createElement('div');
                stepEl.className = "mb-10 ml-6 group";
                let typeColor = "bg-gray-100 dark:bg-gray-700 dark:text-gray-300";
                let badgeClass = "";
                if(step.type === "Wood") badgeClass = "badge-wood";
                if(step.type === "Fruit") badgeClass = "badge-fruit";
                if(step.type === "Calquat") badgeClass = "badge-calquat";
                if(step.type === "Hardwood") badgeClass = "badge-hardwood";
                if(step.type === "Special") badgeClass = "badge-special";
                if(step.type === "Herb") badgeClass = "badge-wood";

                const teleInfo = getSmartTele(step.loc);
                
                const content = `
                    <div class="interactive-row route-step relative flex flex-col sm:flex-row items-start sm:items-center bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm p-4">
                        <div class="flex-grow">
                            <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900 dark:text-gray-100">
                                ${step.loc} 
                                <span class="tree-badge ${badgeClass}">${step.type}</span>
                            </h3>
                            <div class="mb-2 text-sm font-bold text-[#3d5c25] dark:text-green-400">Via: ${teleInfo.text}</div>
                            <p class="mb-2 text-gray-600 dark:text-gray-300 text-sm italic">${step.dir}</p>
                        </div>
                    </div>`;
                stepEl.innerHTML = `<span class="absolute flex items-center justify-center w-8 h-8 bg-white dark:bg-gray-600 rounded-full -left-4 border border-gray-300 dark:border-gray-500 font-bold text-gray-500 dark:text-gray-300">${stepCount}</span>` + content;
                container.appendChild(stepEl);
                const rowDiv = stepEl.querySelector('.interactive-row');
                rowDiv.addEventListener('click', () => {
                    rowDiv.classList.toggle('completed');
                    checkCompletion();
                });
            });
        }

        function checkCompletion() {
            const allItems = document.querySelectorAll('.route-step');
            if (allItems.length === 0) return;
            const completedItems = document.querySelectorAll('.route-step.completed');
            if (completedItems.length === allItems.length) {
                const duration = 3000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };
                const randomInRange = (min, max) => Math.random() * (max - min) + min;
                const interval = setInterval(function() {
                    const timeLeft = animationEnd - Date.now();
                    if (timeLeft <= 0) return clearInterval(interval);
                    const particleCount = 50 * (timeLeft / duration);
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            }
        }

        function renderReference(route) {
            route.innerHTML = '';
            const createSection = (title, data) => {
                const div = document.createElement('div');
                div.className = "mb-8";
                div.innerHTML = `<h3 class="text-xl font-bold text-[#3d5c25] dark:text-green-400 mb-2">${title}</h3>`;
                const table = document.createElement('table');
                table.className = "ref-table text-gray-800 dark:text-gray-200";
                table.innerHTML = `<thead><tr><th>Level</th><th>Tree</th><th>Payment</th></tr></thead>`;
                const tbody = document.createElement('tbody');
                const sortedData = [...data].sort((a,b) => a.lvl - b.lvl);
                sortedData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "dark:border-gray-700";
                    tr.innerHTML = `<td>${item.lvl}</td><td>${item.name}</td><td>${item.payQty} ${item.payItem}</td>`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                div.appendChild(table);
                route.appendChild(div);
            };
            createSection("üå≤ Wood Trees", TREES.wood);
            createSection("üçé Fruit Trees", TREES.fruit);
            createSection("üå¥ Hardwood & Special", [...TREES.hardwood, ...TREES.calquat, ...TREES.celastrus, ...TREES.redwood]);
        }

        function toggleTheme(toggle = true) {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            let isDark = html.classList.contains('dark');
            if(toggle) {
                isDark = !isDark;
                isDark ? html.classList.add('dark') : html.classList.remove('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            } else {
                const saved = localStorage.getItem('theme');
                if(saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    html.classList.add('dark'); isDark = true;
                }
            }
            icon.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        toggleTheme(false);
        updateUI(); 
    </script>
</body>
</html>
