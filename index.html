<!-- Chosen Palette: OSRS Natural (Warm Neutrals, Earthy Greens, UI Browns) + Dark Mode -->
<!-- Application Structure Plan: 
    - NEW FEATURE: Wise Old Man API Integration.
    - Logic Update: 'treePhase1' and 'treePhase2' are now generated dynamically using 'getBestTreeForLevel()'.
    - Math: Calculates total payment costs (e.g., 7 trees * 25 coconuts = 175 coconuts).
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barker's Farm Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cinzel:wght@700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3 {
            font-family: 'Cinzel', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .mode-btn { transition: all 0.2s; border: 2px solid #3d5c25; }
        .mode-btn.active { background-color: #3d5c25; color: white; border-color: #2e461b; }
        
        .dark .mode-btn { border-color: #86efac; color: #86efac; background-color: transparent; }
        .dark .mode-btn.active { background-color: #86efac; color: #064e3b; border-color: #86efac; }

        .phase-header {
            display: flex; align-items: center; justify-content: center; margin: 2rem 0;
            font-weight: bold; font-family: 'Cinzel', serif; font-size: 1.25rem;
            padding: 10px; border-radius: 8px; border-width: 1px;
        }

        .chart-container { position: relative; width: 100%; height: 300px; }
        
        .step-check:checked + div { opacity: 0.5; text-decoration: line-through; }
        .step-check { accent-color: #3d5c25; }

        .item-row.checked { opacity: 0.5; text-decoration: line-through; }
        
        /* Table Styling */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .ref-table th { background-color: #3d5c25; color: white; padding: 8px; text-align: left; font-weight: 600; }
        .ref-table td { padding: 8px; border-bottom-width: 1px; }

        /* API Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3d5c25;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#f0f0eb] text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="absolute top-4 right-4 bg-white dark:bg-gray-700 shadow-md p-2 rounded-full hover:scale-110 transition-transform z-50" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span id="theme-icon">üåô</span>
    </button>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <header class="mb-8 text-center relative pt-8 sm:pt-0">
            <h1 class="text-4xl font-bold text-[#3e2723] dark:text-[#e7d8c9] mb-2">Barker's Farm Run</h1>
            <h2 class="text-lg text-gray-500 dark:text-gray-400 font-semibold mb-2">(No Bean Sprouts)</h2>
            
            <!-- WOM Integration -->
            <div class="flex justify-center items-center gap-2 mb-6 max-w-md mx-auto">
                <input type="text" id="rsn-input" placeholder="OSRS Username" class="px-4 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#3d5c25]" onkeypress="handleEnter(event)">
                <button onclick="fetchStats()" class="bg-[#3d5c25] hover:bg-[#2e461b] text-white px-4 py-2 rounded font-bold transition-colors flex items-center gap-2">
                    Fetch Stats <div id="api-loader" class="loader"></div>
                </button>
            </div>

            <div class="flex justify-center flex-wrap gap-4 mb-4">
                <button onclick="switchMode('herb')" id="btn-herb" class="mode-btn active px-6 py-2 rounded-full font-bold transition-colors">
                    üåø Herb Run
                </button>
                <button onclick="switchMode('tree')" id="btn-tree" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">
                    üå≥ Tree Run
                </button>
                <button onclick="switchMode('reference')" id="btn-ref" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">
                    üìò Quick Reference
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-8">
                
                <!-- Inventory Container -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#3d5c25] dark:border-green-500 transition-colors">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-2xl font-bold text-[#3d5c25] dark:text-green-400" id="prep-title">Herb Inventory</h2>
                        <span id="level-badge" class="bg-[#3d5c25] text-white text-xs px-2 py-1 rounded hidden">Lvl 85</span>
                    </div>
                    <div id="inventory-container" class="space-y-4">
                        <!-- JS will inject lists here -->
                    </div>
                </div>

                <!-- Stats Panel -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#5d4037] dark:border-orange-900 transition-colors" id="stats-panel">
                    <h2 class="text-2xl font-bold mb-3 text-[#5d4037] dark:text-orange-300" id="analysis-title">Yield Analysis</h2>
                    
                    <div id="herb-controls" class="flex flex-col space-y-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Farming Level</label>
                            <input type="range" min="1" max="99" value="85" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-pointer accent-[#3d5c25]" id="level-slider" oninput="updateStatsFromSlider()">
                            <span id="level-val" class="text-sm font-bold text-[#3d5c25] dark:text-green-400">85</span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Compost</label>
                            <select id="compost-select" onchange="updateStats()" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-1">
                                <option value="ultra">Ultracompost</option>
                                <option value="super">Supercompost</option>
                            </select>
                        </div>
                    </div>

                    <div id="tree-controls" class="hidden flex flex-col space-y-4 mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400 italic">XP calculated based on your current level's best trees.</p>
                    </div>

                    <div class="chart-container" id="chart-wrapper">
                        <canvas id="yieldChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Route Main Area -->
            <div class="lg:col-span-8">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg min-h-screen transition-colors">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-[#2e3b2b] dark:text-gray-100" id="route-title">The Route</h2>
                        <div class="text-right" id="progress-container">
                            <span class="block text-sm text-gray-500 dark:text-gray-400">Progress</span>
                            <span class="text-xl font-bold text-[#3d5c25] dark:text-green-400" id="progress-text">0%</span>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-8" id="progress-bar-container">
                        <div class="bg-[#3d5c25] dark:bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%" id="progress-bar"></div>
                    </div>

                    <div class="relative border-l-4 border-gray-200 dark:border-gray-700 ml-4 space-y-12" id="route-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        let currentFarmingLevel = 85; // Default
        let currentMode = 'herb';
        let chartInstance;

        // Tree Definitions (Level, Name, Payment Qty, Payment Item, XP)
        const TREES = {
            wood: [
                { lvl: 75, name: "Magic", payQty: 25, payItem: "Coconuts", xp: 13768.3 },
                { lvl: 60, name: "Yew", payQty: 10, payItem: "Cactus Spines", xp: 7069.9 },
                { lvl: 45, name: "Maple", payQty: 1, payItem: "Basket of Oranges", xp: 3403.4 },
                { lvl: 30, name: "Willow", payQty: 1, payItem: "Basket of Apples", xp: 1456.3 },
                { lvl: 15, name: "Oak", payQty: 1, payItem: "Basket of Tomatoes", xp: 481.3 }
            ],
            fruit: [
                { lvl: 81, name: "Dragonfruit", payQty: 15, payItem: "Coconut", xp: 17335 },
                { lvl: 68, name: "Palm", payQty: 15, payItem: "Papaya Fruit", xp: 10150.1 },
                { lvl: 57, name: "Papaya", payQty: 10, payItem: "Pineapple", xp: 6146.4 },
                { lvl: 51, name: "Pineapple", payQty: 10, payItem: "Watermelon", xp: 4605 },
                { lvl: 42, name: "Curry", payQty: 5, payItem: "Basket of Bananas", xp: 2906.9 },
                { lvl: 39, name: "Orange", payQty: 3, payItem: "Basket of Strawberries", xp: 2470.2 },
                { lvl: 33, name: "Banana", payQty: 4, payItem: "Basket of Apples", xp: 1750.5 },
                { lvl: 27, name: "Apple", payQty: 9, payItem: "Sweetcorn", xp: 1199.5 }
            ],
            hardwood: [
                { lvl: 55, name: "Mahogany", payQty: 25, payItem: "Yanillian Hops", xp: 15720 },
                { lvl: 35, name: "Teak", payQty: 15, payItem: "Limpwurt Roots", xp: 7290 }
            ],
            calquat: [
                { lvl: 72, name: "Calquat", payQty: 8, payItem: "Poison Ivy Berries", xp: 12096 }
            ]
        };

        const herbInventory = [
            { name: "Magic Secateurs" }, { name: "Spade" }, { name: "Seed Dibber" },
            { name: "Bottomless Bucket" }, { name: "House Teleport" },
            { name: "Xeric's Talisman (Optional)" }, { name: "Ectophial" },
            { name: "Explorer's Ring" }, { name: "Ardougne Cloak" },
            { name: "Herb Seeds (9)" }, { name: "Stamina Potion (Optional)" }
        ];

        // Route Data
        const herbRoute = [
            { id: 1, location: "Troll Stronghold", teleport: "PoH Nexus -> Stony Basalt", type: "Disease Free", desc: "Roof patch." },
            { id: 2, location: "Weiss", teleport: "PoH Nexus -> Icy Basalt", type: "Disease Free", desc: "Run west." },
            { id: 3, location: "Farming Guild", teleport: "Jewelry Box", type: "High Yield", desc: "West wing." },
            { id: 4, location: "Catherby", teleport: "PoH Nexus", type: "Standard", desc: "Run east." },
            { id: 5, location: "North Ardougne", teleport: "Cloak", type: "Standard", desc: "Teleport to farm." },
            { id: 6, location: "South Falador", teleport: "Ring", type: "Standard", desc: "Cabbage patch." },
            { id: 7, location: "Port Phasmatys", teleport: "Ectophial", type: "Standard", desc: "Run west." },
            { id: 8, location: "Hosidius", teleport: "Xeric's Talisman", type: "Disease Free", desc: "Glade." },
            { id: 9, location: "Civitas illa Fortis", teleport: "Quetzal Whistle / PoH", type: "Standard", desc: "Varlamore patch." },
            { id: 10, location: "Harmony Island", teleport: "Harmony Is. Teleport", type: "Disease Free", desc: "Optional (Elite Diary)." }
        ];

        const treeRoute = [
            { header: "PHASE 1: Wood (7) & Calquat (3)" },
            { id: 1, location: "Lumbridge", teleport: "PoH Nexus", type: "Wood", desc: "Behind castle." },
            { id: 2, location: "Varrock", teleport: "PoH Nexus", type: "Wood", desc: "Castle park." },
            { id: 3, location: "Falador", teleport: "PoH Nexus", type: "Wood", desc: "Park." },
            { id: 4, location: "Taverley", teleport: "Run North", type: "Wood", desc: "Near balloon." },
            { id: 5, location: "Gnome Stronghold", teleport: "Spirit Tree", type: "Wood", desc: "Near Spirit Tree." },
            { id: 6, location: "Farming Guild", teleport: "Jewelry Box", type: "Wood", desc: "Central." },
            { id: 7, location: "Auburnvale", teleport: "Varlamore Tele", type: "Wood", desc: "Varlamore patch." },
            { id: 8, location: "Tai Bwo Wannai", teleport: "Scroll/Spirit Tree", type: "Calquat", desc: "Standard patch." },
            { id: 9, location: "Great Conch", teleport: "Varlamore Tele", type: "Calquat", desc: "Varlamore patch." },
            { id: 10, location: "Kastori", teleport: "Varlamore Tele", type: "Calquat", desc: "Varlamore patch." },
            { header: "BANK STOP: Tools + Fruit/Hardwood Saplings" },
            { id: 11, location: "Gnome Stronghold", teleport: "Spirit Tree", type: "Fruit", desc: "East of Spirit Tree." },
            { id: 12, location: "Tree Gnome Village", teleport: "Spirit Tree", type: "Fruit", desc: "Follow Elkoy." },
            { id: 13, location: "Brimhaven", teleport: "Spirit Tree", type: "Fruit", desc: "North." },
            { id: 14, location: "Catherby", teleport: "PoH Nexus", type: "Fruit", desc: "East." },
            { id: 15, location: "Lletya", teleport: "Tele Crystal", type: "Fruit", desc: "East." },
            { id: 16, location: "Farming Guild", teleport: "Jewelry Box", type: "Fruit", desc: "Palm patch." },
            { id: 17, location: "Kastori", teleport: "Varlamore Tele", type: "Fruit", desc: "Varlamore patch." },
            { id: 18, location: "Fossil Island (1)", teleport: "Digsite Pendant", type: "Hardwood", desc: "Verdant Valley." },
            { id: 19, location: "Fossil Island (2)", teleport: "Run Adjacent", type: "Hardwood", desc: "Verdant Valley." },
            { id: 20, location: "Fossil Island (3)", teleport: "Run Adjacent", type: "Hardwood", desc: "Verdant Valley." },
            { id: 21, location: "Avium Savannah", teleport: "Civitas/Quetzal", type: "Hardwood", desc: "Varlamore patch." },
            { id: 22, location: "Anglers' Retreat", teleport: "Varlamore Tele", type: "Hardwood", desc: "Varlamore patch." }
        ];

        // --- WOM API Logic ---
        function handleEnter(e) { if(e.key === 'Enter') fetchStats(); }

        async function fetchStats() {
            const rsn = document.getElementById('rsn-input').value;
            const loader = document.getElementById('api-loader');
            if(!rsn) return;

            loader.style.display = 'block';
            
            try {
                const response = await fetch(`https://api.wiseoldman.net/v2/players/${rsn}`);
                if (!response.ok) throw new Error('Player not found');
                const data = await response.json();
                
                // Get Farming Level
                const farmLvl = data.latestSnapshot.data.skills.farming.level;
                currentFarmingLevel = farmLvl;

                // Update UI
                document.getElementById('level-slider').value = farmLvl;
                document.getElementById('level-val').innerText = farmLvl;
                document.getElementById('level-badge').innerText = `Lvl ${farmLvl}`;
                document.getElementById('level-badge').classList.remove('hidden');
                
                // Re-render
                switchMode(currentMode);
                updateStats();

            } catch (err) {
                alert("Could not fetch stats for that user. Defaulting to manual slider.");
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- Smart Tree Logic ---
        function getBestTree(type, level) {
            const options = TREES[type];
            // Options are sorted desc by level, find first that fits
            return options.find(t => level >= t.lvl) || options[options.length - 1];
        }

        function generatePhase1(level) {
            const bestWood = getBestTree('wood', level);
            const calquat = getBestTree('calquat', level); // Always calquat if >72, but logic holds
            
            // Payment Math
            const woodPayTotal = bestWood.payQty * 7;
            const calqPayTotal = calquat.payQty * 3;

            return [
                { name: "Spade" }, { name: "Coins" }, { name: "House Teleport" },
                { name: `${bestWood.name} Saplings (7)` },
                { name: `Calquat Saplings (3)` },
                { name: `Pay: ${woodPayTotal} ${bestWood.payItem} (Wood)` },
                { name: `Pay: ${calqPayTotal} ${calquat.payItem} (Calquat)` }
            ];
        }

        function generatePhase2(level) {
            const bestFruit = getBestTree('fruit', level);
            const bestHard = getBestTree('hardwood', level);
            
            // Payment Math
            const fruitPayTotal = bestFruit.payQty * 7;
            const hardPayTotal = bestHard.payQty * 5;

            return [
                { name: "Spade" }, 
                { name: "Crystal Teleport" }, { name: "Digsite Pendant" },
                { name: `${bestFruit.name} Saplings (7)` },
                { name: `${bestHard.name} Saplings (5)` },
                { name: `Pay: ${fruitPayTotal} ${bestFruit.payItem} (Fruit)` },
                { name: `Pay: ${hardPayTotal} ${bestHard.payItem} (Hardwood)` }
            ];
        }

        // --- Core UI Logic ---

        function init() {
            initChart();
            switchMode('herb');
            toggleTheme(false); // Init theme
        }
        
        function initChart() {
            const ctx = document.getElementById('yieldChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Val', data: [], borderWidth: 1 }] },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateStatsFromSlider() {
            currentFarmingLevel = parseInt(document.getElementById('level-slider').value);
            document.getElementById('level-val').innerText = currentFarmingLevel;
            // If in tree mode, we need to re-render inventory to show new trees
            if(currentMode === 'tree') {
                switchMode('tree');
            } else {
                updateStats();
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            // Update button styles
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if(mode === 'herb') document.getElementById('btn-herb').classList.add('active');
            if(mode === 'tree') document.getElementById('btn-tree').classList.add('active');
            if(mode === 'reference') document.getElementById('btn-ref').classList.add('active');

            const invContainer = document.getElementById('inventory-container');
            const routeCont = document.getElementById('route-container');
            invContainer.innerHTML = '';

            const statsPanel = document.getElementById('stats-panel');
            const progCont = document.getElementById('progress-container');
            const progBar = document.getElementById('progress-bar-container');

            if(mode === 'reference') {
                statsPanel.classList.add('hidden');
                progCont.classList.add('hidden');
                progBar.classList.add('hidden');
                routeCont.classList.remove('border-l-4'); 
                document.getElementById('prep-title').innerText = "Quick Tips";
                invContainer.innerHTML = `<div class='text-sm text-gray-700 dark:text-gray-300 space-y-2'><p>Compost: Ultracompost.</p><p>Note items at Leprechaun.</p></div>`;
                document.getElementById('route-title').innerText = "Reference";
                renderReference();
            } else {
                statsPanel.classList.remove('hidden');
                progCont.classList.remove('hidden');
                progBar.classList.remove('hidden');
                routeCont.classList.add('border-l-4');

                if (mode === 'herb') {
                    document.getElementById('prep-title').innerText = "Herb Inventory";
                    document.getElementById('route-title').innerText = "Herb Route";
                    document.getElementById('herb-controls').classList.remove('hidden');
                    document.getElementById('tree-controls').classList.add('hidden');
                    
                    const listDiv = document.createElement('div');
                    listDiv.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 max-h-[500px] overflow-y-auto space-y-2";
                    renderList(herbInventory, listDiv);
                    invContainer.appendChild(listDiv);
                    renderRoute(herbRoute);
                } else if (mode === 'tree') {
                    document.getElementById('prep-title').innerText = "Tree Run (Smart)";
                    document.getElementById('route-title').innerText = "Ultimate Tree Route";
                    document.getElementById('herb-controls').classList.add('hidden');
                    document.getElementById('tree-controls').classList.remove('hidden');
                    
                    // Generate dynamic lists based on current level
                    const p1List = generatePhase1(currentFarmingLevel);
                    const p2List = generatePhase2(currentFarmingLevel);

                    const p1Label = document.createElement('h3');
                    p1Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-0 text-sm uppercase tracking-wide";
                    p1Label.innerText = "Phase 1: Wood & Calquat";
                    invContainer.appendChild(p1Label);

                    const list1Div = document.createElement('div');
                    list1Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 mb-4 space-y-2";
                    renderList(p1List, list1Div);
                    invContainer.appendChild(list1Div);

                    const p2Label = document.createElement('h3');
                    p2Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-2 text-sm uppercase tracking-wide";
                    p2Label.innerText = "Phase 2: Fruit & Hardwood";
                    invContainer.appendChild(p2Label);

                    const list2Div = document.createElement('div');
                    list2Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 space-y-2";
                    renderList(p2List, list2Div);
                    invContainer.appendChild(list2Div);

                    renderRoute(treeRoute);
                }
                updateStats();
            }
        }

        function renderList(items, container) {
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'item-row flex items-center p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors shadow-sm';
                row.innerHTML = `<span class="text-sm font-semibold text-gray-800 dark:text-gray-100">${item.name}</span>`;
                row.onclick = () => row.classList.toggle('checked');
                container.appendChild(row);
            });
        }

        function renderRoute(data) {
            const container = document.getElementById('route-container');
            container.innerHTML = '';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').innerText = '0%';
            
            let stepCount = 0;
            data.forEach((step, index) => {
                if (step.header) {
                    const header = document.createElement('div');
                    header.className = "phase-header text-[#78350f] bg-[#fef3c7] border-[#d97706] dark:text-amber-100 dark:bg-amber-900/40 dark:border-amber-700";
                    header.innerText = step.header;
                    container.appendChild(header);
                    return;
                }
                stepCount++; 
                const stepEl = document.createElement('div');
                stepEl.className = "mb-10 ml-6 group";
                let typeColor = "bg-gray-100 dark:bg-gray-700 dark:text-gray-300";
                if(step.type.includes("Wood")) typeColor = "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";
                if(step.type.includes("Fruit")) typeColor = "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200";
                if(step.type.includes("Calquat")) typeColor = "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";
                if(step.type.includes("Hardwood")) typeColor = "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";

                const content = `
                    <div class="relative flex flex-col sm:flex-row items-start sm:items-center bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm p-4 transition-colors">
                        <div class="flex-grow">
                            <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900 dark:text-gray-100">${step.location} <span class="${typeColor} text-xs font-medium mr-2 px-2.5 py-0.5 rounded ml-3">${step.type}</span></h3>
                            <div class="mb-2 text-sm text-gray-500 dark:text-gray-400">Via: ${step.teleport}</div>
                            <p class="mb-2 text-gray-600 dark:text-gray-300 text-sm">${step.desc}</p>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-4"><input type="checkbox" class="step-check w-6 h-6 text-green-600 rounded cursor-pointer" onchange="updateProgress()"></div>
                    </div>`;
                stepEl.innerHTML = `<span class="absolute flex items-center justify-center w-8 h-8 bg-white dark:bg-gray-600 rounded-full -left-4 border border-gray-300 dark:border-gray-500 font-bold text-gray-500 dark:text-gray-300">${stepCount}</span>` + content;
                container.appendChild(stepEl);
            });
        }

        function renderReference() {
            const container = document.getElementById('route-container');
            container.innerHTML = '';
            
            const createSection = (title, data, showPay) => {
                const div = document.createElement('div');
                div.className = "mb-8";
                div.innerHTML = `<h3 class="text-xl font-bold text-[#3d5c25] dark:text-green-400 mb-2">${title}</h3>`;
                
                const table = document.createElement('table');
                table.className = "ref-table text-gray-800 dark:text-gray-200";
                
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>Level</th><th>Tree</th>${showPay?'<th>Payment</th>':''}</tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "dark:border-gray-700";
                    tr.innerHTML = `<td>${item.lvl}</td><td>${item.name}</td>${showPay?`<td>${item.payQty} ${item.payItem}</td>`:''}`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                div.appendChild(table);
                container.appendChild(div);
            };

            createSection("üå≤ Wood Trees", TREES.wood, true);
            createSection("üçé Fruit Trees", TREES.fruit, true);
            createSection("üå¥ Hardwood & Special", [...TREES.hardwood, ...TREES.calquat], true);
        }

        function updateProgress() {
            const checks = document.querySelectorAll('.step-check');
            const total = checks.length;
            const checked = Array.from(checks).filter(c => c.checked).length;
            const pct = Math.round((checked / total) * 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('progress-text').innerText = `${pct}%`;
        }

        function updateStats() {
            // Re-render chart logic with WOM data
            if(currentMode === 'herb') {
                const level = currentFarmingLevel;
                let base = 6 + (level/20);
                const compost = document.getElementById('compost-select').value;
                if(compost === 'ultra') base += 2; else base += 1;
                chartInstance.data.labels = ['Disease Free (4)', 'Standard (6)'];
                chartInstance.data.datasets[0].label = 'Herbs';
                chartInstance.data.datasets[0].data = [(4*base).toFixed(1), (6*base*0.9).toFixed(1)];
                chartInstance.data.datasets[0].backgroundColor = ['#4ade80', '#fbbf24'];
            } else if (currentMode === 'tree') {
                const wood = getBestTree('wood', currentFarmingLevel);
                const fruit = getBestTree('fruit', currentFarmingLevel);
                const hard = getBestTree('hardwood', currentFarmingLevel);
                const calq = getBestTree('calquat', currentFarmingLevel);

                chartInstance.data.labels = [`${wood.name} (7)`, `${fruit.name} (7)`, 'Calquat (3)', 'Hardwood (5)'];
                chartInstance.data.datasets[0].label = 'Total XP';
                chartInstance.data.datasets[0].data = [
                    (wood.xp * 7).toFixed(0), 
                    (fruit.xp * 7).toFixed(0), 
                    (calq.xp * 3).toFixed(0), 
                    (hard.xp * 5).toFixed(0)
                ];
                chartInstance.data.datasets[0].backgroundColor = ['#a52a2a', '#ffa500', '#fcd34d', '#7f1d1d'];
            }
            updateChartTheme();
            chartInstance.update();
        }

        function updateChartTheme() {
            if (chartInstance) {
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e5e7eb' : '#374151';
                chartInstance.options.scales.x.ticks.color = textColor;
                chartInstance.options.scales.y.ticks.color = textColor;
                chartInstance.options.plugins.legend.labels.color = textColor;
                chartInstance.update();
            }
        }

        // Theme Toggle
        function toggleTheme(toggle = true) {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            let isDark = html.classList.contains('dark');
            
            if(toggle) {
                isDark = !isDark;
                isDark ? html.classList.add('dark') : html.classList.remove('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            } else {
                // Init load
                const saved = localStorage.getItem('theme');
                if(saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    html.classList.add('dark'); isDark = true;
                }
            }
            icon.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            updateChartTheme();
        }

        init();
    </script>
</body>
</html>
