<!-- Chosen Palette: OSRS Natural (Warm Neutrals, Earthy Greens, UI Browns) + Dark Mode -->
<!-- Application Structure Plan: 
    - UPDATE: Overhauled the "Reference" tab Sidebar.
    - Content: Added detailed "Pro Tips" regarding Tool Leprechaun noting, Spam Clicking, Compost mechanics, and Anima seeds.
    - Visuals: Styled tips as distinct cards for better readability.
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barker's Farm Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cinzel:wght@700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Cinzel', serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .mode-btn { transition: all 0.2s; border: 2px solid #3d5c25; }
        .mode-btn.active { background-color: #3d5c25; color: white; border-color: #2e461b; }
        
        .dark .mode-btn { border-color: #86efac; color: #86efac; background-color: transparent; }
        .dark .mode-btn.active { background-color: #86efac; color: #064e3b; border-color: #86efac; }

        .phase-header {
            display: flex; align-items: center; justify-content: center; margin: 2rem 0;
            font-weight: bold; font-family: 'Cinzel', serif; font-size: 1.25rem;
            padding: 10px; border-radius: 8px; border-width: 1px;
        }

        .chart-container { position: relative; width: 100%; height: 300px; }
        
        /* Interactive Row Styling */
        .interactive-row {
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .interactive-row.completed {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #22c55e !important; /* green-500 */
            opacity: 0.8;
        }
        
        .dark .interactive-row.completed {
            background-color: #064e3b !important; /* green-900 */
            border-color: #4ade80 !important; /* green-400 */
            opacity: 0.9;
        }

        /* Table Styling */
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .ref-table th { background-color: #3d5c25; color: white; padding: 8px; text-align: left; font-weight: 600; }
        .ref-table td { padding: 8px; border-bottom-width: 1px; }

        /* API Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3d5c25;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#f0f0eb] text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="absolute top-4 right-4 bg-white dark:bg-gray-700 shadow-md p-2 rounded-full hover:scale-110 transition-transform z-50" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span id="theme-icon">üåô</span>
    </button>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header -->
        <header class="mb-8 text-center relative pt-8 sm:pt-0">
            <h1 class="text-4xl font-bold text-[#3e2723] dark:text-[#e7d8c9] mb-2">Barker's Farm Run</h1>
            <h2 class="text-lg text-gray-500 dark:text-gray-400 font-semibold mb-6">(No Bean Sprouts)</h2>
            
            <!-- INPUT SECTION -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 max-w-xl mx-auto mb-8 border border-gray-200 dark:border-gray-700">
                
                <!-- WOM Integration -->
                <div class="flex justify-center items-center gap-2 mb-4">
                    <input type="text" id="rsn-input" placeholder="OSRS Username" class="flex-grow px-4 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#3d5c25]" onkeypress="handleEnter(event)">
                    <button onclick="fetchStats()" class="bg-[#3d5c25] hover:bg-[#2e461b] text-white px-4 py-2 rounded font-bold transition-colors flex items-center gap-2 whitespace-nowrap">
                        Fetch Stats <div id="api-loader" class="loader"></div>
                    </button>
                </div>

                <!-- OR Divider -->
                <div class="relative flex py-2 items-center mb-4">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-sm font-semibold">OR SET MANUALLY</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>

                <!-- Level Slider -->
                <div class="flex items-center gap-4">
                    <label class="whitespace-nowrap text-sm font-medium text-gray-700 dark:text-gray-300">Farming Level:</label>
                    <input type="range" min="1" max="99" value="85" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg cursor-pointer accent-[#3d5c25]" id="level-slider" oninput="updateStatsFromSlider()">
                    <span id="level-val" class="text-lg font-bold text-[#3d5c25] dark:text-green-400 w-8 text-center">85</span>
                </div>
            </div>

            <!-- Mode Buttons -->
            <div class="flex justify-center flex-wrap gap-4 mb-4">
                <button onclick="switchMode('herb')" id="btn-herb" class="mode-btn active px-6 py-2 rounded-full font-bold transition-colors">
                    üåø Herb Run
                </button>
                <button onclick="switchMode('tree')" id="btn-tree" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">
                    üå≥ Tree Run
                </button>
                <button onclick="switchMode('reference')" id="btn-ref" class="mode-btn px-6 py-2 rounded-full font-bold transition-colors">
                    üìò Reference
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar -->
            <div class="lg:col-span-4 space-y-8">
                
                <!-- Inventory Container -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#3d5c25] dark:border-green-500 transition-colors">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-2xl font-bold text-[#3d5c25] dark:text-green-400" id="prep-title">Herb Inventory</h2>
                    </div>
                    <div id="inventory-container" class="space-y-4">
                        <!-- JS will inject lists here -->
                    </div>
                </div>

                <!-- Stats Panel -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-t-4 border-[#5d4037] dark:border-orange-900 transition-colors" id="stats-panel">
                    <h2 class="text-2xl font-bold mb-3 text-[#5d4037] dark:text-orange-300" id="analysis-title">Yield Analysis</h2>
                    
                    <!-- Compost Control Only -->
                    <div id="herb-controls" class="flex flex-col space-y-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Compost</label>
                            <select id="compost-select" onchange="updateStats()" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
                                <option value="ultra">Ultracompost</option>
                                <option value="super">Supercompost</option>
                            </select>
                        </div>
                    </div>

                    <div class="chart-container" id="chart-wrapper">
                        <canvas id="yieldChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Route Main Area -->
            <div class="lg:col-span-8">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg min-h-screen transition-colors">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-[#2e3b2b] dark:text-gray-100" id="route-title">The Route</h2>
                        <div class="text-right" id="progress-container">
                            <span class="block text-sm text-gray-500 dark:text-gray-400">Progress</span>
                            <span class="text-xl font-bold text-[#3d5c25] dark:text-green-400" id="progress-text">0%</span>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-8" id="progress-bar-container">
                        <div class="bg-[#3d5c25] dark:bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%" id="progress-bar"></div>
                    </div>

                    <div class="relative border-l-4 border-gray-200 dark:border-gray-700 ml-4 space-y-12" id="route-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        let currentFarmingLevel = 85; 
        let currentMode = 'herb';
        let chartInstance;

        const TREES = {
            wood: [
                { lvl: 75, name: "Magic", payQty: 25, payItem: "Coconuts", xp: 13768.3 },
                { lvl: 60, name: "Yew", payQty: 10, payItem: "Cactus Spines", xp: 7069.9 },
                { lvl: 45, name: "Maple", payQty: 1, payItem: "Basket of Oranges", xp: 3403.4 },
                { lvl: 30, name: "Willow", payQty: 1, payItem: "Basket of Apples", xp: 1456.3 },
                { lvl: 15, name: "Oak", payQty: 1, payItem: "Basket of Tomatoes", xp: 481.3 }
            ],
            fruit: [
                { lvl: 81, name: "Dragonfruit", payQty: 15, payItem: "Coconut", xp: 17335 },
                { lvl: 68, name: "Palm", payQty: 15, payItem: "Papaya Fruit", xp: 10150.1 },
                { lvl: 57, name: "Papaya", payQty: 10, payItem: "Pineapple", xp: 6146.4 },
                { lvl: 51, name: "Pineapple", payQty: 10, payItem: "Watermelon", xp: 4605 },
                { lvl: 42, name: "Curry", payQty: 5, payItem: "Basket of Bananas", xp: 2906.9 },
                { lvl: 39, name: "Orange", payQty: 3, payItem: "Basket of Strawberries", xp: 2470.2 },
                { lvl: 33, name: "Banana", payQty: 4, payItem: "Basket of Apples", xp: 1750.5 },
                { lvl: 27, name: "Apple", payQty: 9, payItem: "Sweetcorn", xp: 1199.5 }
            ],
            hardwood: [
                { lvl: 55, name: "Mahogany", payQty: 25, payItem: "Yanillian Hops", xp: 15720 },
                { lvl: 35, name: "Teak", payQty: 15, payItem: "Limpwurt Roots", xp: 7290 }
            ],
            calquat: [ { lvl: 72, name: "Calquat", payQty: 8, payItem: "Poison Ivy Berries", xp: 12096 } ],
            crystal: [ { lvl: 74, name: "Crystal Tree", payQty: 0, payItem: "None", xp: 13240 } ],
            celastrus: [ { lvl: 85, name: "Celastrus", payQty: 8, payItem: "Potato Cactus", xp: 14130 } ],
            redwood: [ { lvl: 90, name: "Redwood", payQty: 6, payItem: "Dragonfruit", xp: 22450 } ]
        };

        const HERBS = [
            { lvl: 85, name: "Torstol" },
            { lvl: 79, name: "Dwarf Weed" },
            { lvl: 73, name: "Lantadyme" },
            { lvl: 67, name: "Cadantine" },
            { lvl: 62, name: "Snapdragon" },
            { lvl: 56, name: "Kwuarm" },
            { lvl: 50, name: "Avantoe" },
            { lvl: 44, name: "Irit" },
            { lvl: 38, name: "Toadflax" },
            { lvl: 32, name: "Ranarr" },
            { lvl: 26, name: "Harralander" },
            { lvl: 19, name: "Tarromin" },
            { lvl: 14, name: "Marrentill" },
            { lvl: 9, name: "Guam" }
        ];

        // --- Logic ---
        function handleEnter(e) { if(e.key === 'Enter') fetchStats(); }

        async function fetchStats() {
            const rsn = document.getElementById('rsn-input').value;
            const loader = document.getElementById('api-loader');
            if(!rsn) return;

            loader.style.display = 'block';
            try {
                const response = await fetch(`https://api.wiseoldman.net/v2/players/${rsn}`);
                if (!response.ok) throw new Error('Player not found');
                const data = await response.json();
                const farmLvl = data.latestSnapshot.data.skills.farming.level;
                currentFarmingLevel = farmLvl;

                document.getElementById('level-slider').value = farmLvl;
                document.getElementById('level-val').innerText = farmLvl;
                
                switchMode(currentMode);
                updateStats();
            } catch (err) {
                alert("Could not fetch stats.");
            } finally {
                loader.style.display = 'none';
            }
        }

        function getBestTree(type, level) {
            const options = TREES[type];
            return options.find(t => level >= t.lvl); 
        }

        function getBestHerb(level) {
            return HERBS.find(h => level >= h.lvl) || HERBS[HERBS.length-1];
        }

        function generateHerbInventory(level) {
            const bestHerb = getBestHerb(level);
            return [
                { name: "Magic Secateurs" }, { name: "Spade" }, { name: "Seed Dibber" },
                { name: "Bottomless Bucket" }, { name: "House Teleport" },
                { name: "Xeric's Talisman (If Not Mounted)" }, { name: "Ectophial" },
                { name: "Explorer's Ring" }, { name: "Ardougne Cloak" },
                { name: `${bestHerb.name} Seeds (9)` }, 
                { name: "Stamina Potion (Optional)" }
            ];
        }

        function generatePhase1(level) {
            const list = [{ name: "Spade" }, { name: "Coins" }, { name: "House Teleport" }];
            
            // Wood Trees (7) - Min Level 15 (Oak)
            if (level >= 15) {
                const bestWood = getBestTree('wood', level);
                if(bestWood) {
                    list.push({ name: `${bestWood.name} Saplings (7)` });
                    list.push({ name: `Pay: ${bestWood.payQty * 7} ${bestWood.payItem} (Wood)` });
                }
            }

            // HUB FRUIT TREES (2: Stronghold + Guild) - Min Level 27 (Apple)
            if (level >= 27) {
                const bestFruit = getBestTree('fruit', level);
                if(bestFruit) {
                    list.push({ name: `${bestFruit.name} Saplings (2)` });
                    list.push({ name: `Pay: ${bestFruit.payQty * 2} ${bestFruit.payItem} (Hub Fruit)` });
                }
            }

            // Crystal (Level 74)
            if (level >= 74) {
                list.push({ name: "Crystal Acorn (1)" });
            }

            // Celastrus (Level 85) - Guild Hub
            if (level >= 85) {
                const cel = TREES.celastrus[0];
                list.push({ name: "Celastrus Sapling (1)" });
                list.push({ name: `Pay: ${cel.payQty} ${cel.payItem}` });
            }

            // Redwood (Level 90) - Guild Hub
            if (level >= 90) {
                const red = TREES.redwood[0];
                list.push({ name: "Redwood Sapling (1)" });
                list.push({ name: `Pay: ${red.payQty} ${red.payItem}` });
            }

            // Calquat (Level 72)
            if (level >= 72) {
                const calquat = TREES.calquat[0];
                list.push({ name: `Calquat Saplings (3)` });
                list.push({ name: `Pay: ${calquat.payQty * 3} ${calquat.payItem} (Calquat)` });
            }

            return list;
        }

        function generatePhase2(level) {
            // Check if Phase 2 is even possible
            if (level < 27) return []; // No Fruit or Hardwood allowed

            const list = [
                { name: "Spade" }, 
                { name: "Crystal Teleport" }, { name: "Digsite Pendant" }
            ];

            // Fruit Trees (5 remaining) - Min Level 27
            if (level >= 27) {
                const bestFruit = getBestTree('fruit', level);
                if(bestFruit) {
                    list.push({ name: `${bestFruit.name} Saplings (5)` });
                    list.push({ name: `Pay: ${bestFruit.payQty * 5} ${bestFruit.payItem} (Fruit)` });
                }
            }

            // Hardwood (Level 35+)
            if (level >= 35) {
                const bestHard = getBestTree('hardwood', level);
                if(bestHard) {
                    list.push({ name: `${bestHard.name} Saplings (5)` });
                    list.push({ name: `Pay: ${bestHard.payQty * 5} ${bestHard.payItem} (Hardwood)` });
                }
            }

            return list;
        }

        // --- Core UI Logic ---

        function init() {
            initChart();
            switchMode('herb');
            toggleTheme(false); 
        }
        
        function initChart() {
            const ctx = document.getElementById('yieldChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Val', data: [], borderWidth: 1 }] },
                options: { maintainAspectRatio: false, responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateStatsFromSlider() {
            currentFarmingLevel = parseInt(document.getElementById('level-slider').value);
            document.getElementById('level-val').innerText = currentFarmingLevel;
            
            if(currentMode === 'tree' || currentMode === 'herb') {
                switchMode(currentMode); 
            } else {
                updateStats();
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if(mode === 'herb') document.getElementById('btn-herb').classList.add('active');
            if(mode === 'tree') document.getElementById('btn-tree').classList.add('active');
            if(mode === 'reference') document.getElementById('btn-ref').classList.add('active');

            const invContainer = document.getElementById('inventory-container');
            const routeCont = document.getElementById('route-container');
            invContainer.innerHTML = '';

            const statsPanel = document.getElementById('stats-panel');
            const progCont = document.getElementById('progress-container');
            const progBar = document.getElementById('progress-bar-container');

            if(mode === 'reference') {
                statsPanel.classList.add('hidden');
                progCont.classList.add('hidden');
                progBar.classList.add('hidden');
                routeCont.classList.remove('border-l-4'); 
                
                document.getElementById('prep-title').innerText = "Quick Tips";
                
                // Detailed Tips
                const tipsHTML = `
                    <div class="space-y-4">
                        <div class="p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                            <h4 class="font-bold text-green-800 dark:text-green-300 mb-1 flex items-center">üìù Note Your Crops</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Use harvest (herbs, produce, logs) on the <strong>Tool Leprechaun</strong> to note them. Essential for long runs!</p>
                        </div>
                        <div class="p-3 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg">
                            <h4 class="font-bold text-orange-800 dark:text-orange-300 mb-1 flex items-center">üõ°Ô∏è Protection vs. Compost</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Paying the farmer guarantees the crop won't die. If you pay, you don't <em>need</em> compost, but <strong>Ultracompost</strong> still increases harvest yield.</p>
                        </div>
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <h4 class="font-bold text-blue-800 dark:text-blue-300 mb-1 flex items-center">‚ö° Speed Harvest</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Spam click</strong> herb patches to harvest faster. Clean herbs while running to the next patch to save inventory space.</p>
                        </div>
                        <div class="p-3 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg">
                            <h4 class="font-bold text-purple-800 dark:text-purple-300 mb-1 flex items-center">üå± Anima Seeds</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Plant an <strong>Attas</strong> seed at the Anima Patch (Farming Guild) for more yield, or <strong>Iasor</strong> for lower disease chance.</p>
                        </div>
                    </div>
                `;
                invContainer.innerHTML = tipsHTML;
                document.getElementById('route-title').innerText = "Reference (Low to High)";
                renderReference();
            } else {
                statsPanel.classList.remove('hidden');
                progCont.classList.remove('hidden');
                progBar.classList.remove('hidden');
                routeCont.classList.add('border-l-4');

                if (mode === 'herb') {
                    document.getElementById('prep-title').innerText = "Herb Inventory";
                    document.getElementById('route-title').innerText = "Herb Route";
                    document.getElementById('herb-controls').classList.remove('hidden');
                    
                    const listDiv = document.createElement('div');
                    listDiv.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 max-h-[500px] overflow-y-auto space-y-2";
                    renderList(generateHerbInventory(currentFarmingLevel), listDiv);
                    invContainer.appendChild(listDiv);
                    renderRoute(generateHerbRoute()); 
                } else if (mode === 'tree') {
                    document.getElementById('prep-title').innerText = "Tree Inventory";
                    document.getElementById('route-title').innerText = "Hub-Optimized Route";
                    document.getElementById('herb-controls').classList.add('hidden');
                    
                    const p1List = generatePhase1(currentFarmingLevel);
                    const p2List = generatePhase2(currentFarmingLevel);

                    const p1Label = document.createElement('h3');
                    p1Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-0 text-sm uppercase tracking-wide";
                    p1Label.innerText = "Phase 1: Wood + Hubs + Calquat";
                    invContainer.appendChild(p1Label);

                    const list1Div = document.createElement('div');
                    list1Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 mb-4 space-y-2";
                    renderList(p1List, list1Div);
                    invContainer.appendChild(list1Div);

                    // Only show Phase 2 box if there are items (Level >= 27)
                    if (p2List.length > 0) {
                        const p2Label = document.createElement('h3');
                        p2Label.className = "font-bold text-gray-700 dark:text-gray-300 mb-1 mt-2 text-sm uppercase tracking-wide";
                        p2Label.innerText = "Phase 2: Remaining Fruit & Hardwood";
                        invContainer.appendChild(p2Label);

                        const list2Div = document.createElement('div');
                        list2Div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 space-y-2";
                        renderList(p2List, list2Div);
                        invContainer.appendChild(list2Div);
                    }

                    renderRoute(generateTreeRoute(currentFarmingLevel));
                }
                updateStats();
            }
        }

        // Generate Route Arrays based on Level
        function generateHerbRoute() {
            return [
                { id: 1, location: "Troll Stronghold", teleport: "PoH Nexus -> Stony Basalt", type: "Disease Free", desc: "Run to roof patch." },
                { id: 2, location: "Weiss", teleport: "PoH Nexus -> Icy Basalt", type: "Disease Free", desc: "Run west to patch." },
                { id: 3, location: "Farming Guild", teleport: "Jewelry Box -> Farming Guild", type: "High Yield", desc: "West wing (85+) or central." },
                { id: 4, location: "Catherby", teleport: "PoH Nexus -> Catherby", type: "Standard", desc: "Run east." },
                { id: 5, location: "North Ardougne", teleport: "Cloak", type: "Standard", desc: "Teleport to farm." },
                { id: 6, location: "South Falador", teleport: "Ring", type: "Standard", desc: "Run NW from cabbage patch." },
                { id: 7, location: "Port Phasmatys", teleport: "Ectophial", type: "Standard", desc: "Run west." },
                { id: 8, location: "Hosidius", teleport: "Xeric's Talisman", type: "Disease Free", desc: "Run south from Glade." },
                { id: 9, location: "Civitas illa Fortis", teleport: "Quetzal Whistle / PoH", type: "Standard", desc: "Run south-east." },
                { id: 10, location: "Harmony Island", teleport: "Harmony Is. Teleport", type: "Disease Free (Elite)", desc: "Run south. Requires Elite Diary." }
            ];
        }

        function generateTreeRoute(level) {
            const r = [];
            
            // --- PHASE 1 ---
            // Only show Phase 1 if level >= 15 (Wood)
            if (level >= 15) {
                r.push({ header: "PHASE 1: Wood + Hubs + Calquat" });
                r.push({ location: "Lumbridge", teleport: "PoH Nexus -> Lumbridge", type: "Wood", desc: "Run North to patch behind castle." });
                r.push({ location: "Varrock", teleport: "PoH Nexus -> Varrock", type: "Wood", desc: "Run North to Castle park patch." });
                r.push({ location: "Falador", teleport: "PoH Nexus -> Falador", type: "Wood", desc: "Run East to Falador Park." });
                r.push({ location: "Taverley", teleport: "Run North from Falador", type: "Wood", desc: "Run North from Falador park." });
                
                // GNOME STRONGHOLD HUB
                r.push({ location: "Gnome Stronghold (Wood)", teleport: "Spirit Tree", type: "Wood", desc: "Run SW from Spirit Tree." });
                if (level >= 27) { // Check for Fruit level
                    r.push({ location: "Gnome Stronghold (Fruit)", teleport: "Run East", type: "Fruit", desc: "Run East from Spirit Tree." });
                }
                
                // FARMING GUILD HUB
                r.push({ location: "Farming Guild (Wood)", teleport: "Jewelry Box", type: "Wood", desc: "Central patch." });
                if (level >= 27) {
                    r.push({ location: "Farming Guild (Fruit)", teleport: "Run", type: "Fruit", desc: "East Wing." });
                }
                if (level >= 85) {
                    r.push({ location: "Farming Guild (Celastrus)", teleport: "Run", type: "Celastrus", desc: "West Wing." });
                }
                if (level >= 90) {
                    r.push({ location: "Farming Guild (Redwood)", teleport: "Run", type: "Redwood", desc: "West Wing." });
                }
                
                r.push({ location: "Auburnvale", teleport: "Varlamore Tele", type: "Wood", desc: "Run to patch." });
                
                if (level >= 74) {
                    r.push({ location: "Prifddinas", teleport: "Spirit Tree / Crystal Tele", type: "Crystal", desc: "Trahaearn district (North)." });
                }

                if (level >= 72) {
                    r.push({ location: "Tai Bwo Wannai", teleport: "Scroll/Spirit Tree", type: "Calquat", desc: "Run to patch." });
                    r.push({ location: "Great Conch", teleport: "Fairy Ring (ALP) / Quetzal", type: "Calquat", desc: "Run slightly South-East." });
                    r.push({ location: "Kastori", teleport: "Varlamore Tele (Quetzal 2)", type: "Calquat", desc: "Run to patch." });
                }
            }

            // --- PHASE 2 ---
            // Only show Phase 2 if level >= 27 (Fruit) OR 35 (Hardwood)
            if (level >= 27) {
                r.push({ header: "PHASE 2: Tools + Fruit/Hardwood" });

                r.push({ location: "Tree Gnome Village", teleport: "Spirit Tree -> Village", type: "Fruit", desc: "Follow Elkoy, squeeze fence, run SW." });
                r.push({ location: "Brimhaven", teleport: "Spirit Tree -> Brimhaven", type: "Fruit", desc: "Run North/East to patch." });
                r.push({ location: "Catherby", teleport: "PoH Nexus -> Catherby", type: "Fruit", desc: "Run East past bank to patch." });
                r.push({ location: "Lletya", teleport: "Tele Crystal", type: "Fruit", desc: "Run East/Down." });
                r.push({ location: "Kastori", teleport: "Varlamore Tele", type: "Fruit", desc: "Run to patch." });

                if (level >= 35) {
                    r.push({ location: "Fossil Island (1)", teleport: "Digsite Pendant", type: "Hardwood", desc: "Magic Mushtree to Verdant Valley." });
                    r.push({ location: "Fossil Island (2)", teleport: "Run Adjacent", type: "Hardwood", desc: "Magic Mushtree to Verdant Valley." });
                    r.push({ location: "Fossil Island (3)", teleport: "Run Adjacent", type: "Hardwood", desc: "Magic Mushtree to Verdant Valley." });
                    r.push({ location: "Avium Savannah", teleport: "Quetzal Whistle (Hunter Guild)", type: "Hardwood", desc: "Run South from Guild." });
                    r.push({ location: "Anglers' Retreat", teleport: "Fairy Ring (AKP) / Whistle", type: "Hardwood", desc: "Run West from ring." });
                }
            }

            return r;
        }

        function renderList(items, container) {
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'interactive-row flex items-center p-3 bg-white dark:bg-gray-600 rounded border border-gray-200 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 shadow-sm';
                row.innerHTML = `<span class="text-sm font-semibold text-gray-800 dark:text-gray-100">${item.name}</span>`;
                row.onclick = () => row.classList.toggle('completed');
                container.appendChild(row);
            });
        }

        function renderRoute(data) {
            const container = document.getElementById('route-container');
            container.innerHTML = '';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').innerText = '0%';
            
            let stepCount = 0;
            data.forEach((step, index) => {
                if (step.header) {
                    const header = document.createElement('div');
                    header.className = "phase-header text-[#78350f] bg-[#fef3c7] border-[#d97706] dark:text-amber-100 dark:bg-amber-900/40 dark:border-amber-700";
                    header.innerText = step.header;
                    container.appendChild(header);
                    return;
                }
                stepCount++; 
                const stepEl = document.createElement('div');
                stepEl.className = "mb-10 ml-6 group";
                
                let typeColor = "bg-gray-100 dark:bg-gray-700 dark:text-gray-300";
                if(step.type.includes("Wood")) typeColor = "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";
                if(step.type.includes("Fruit")) typeColor = "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200";
                if(step.type.includes("Calquat")) typeColor = "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";
                if(step.type.includes("Hardwood")) typeColor = "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";
                if(step.type.includes("Crystal") || step.type.includes("Redwood") || step.type.includes("Celastrus")) 
                    typeColor = "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200";

                const content = `
                    <div class="interactive-row relative flex flex-col sm:flex-row items-start sm:items-center bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm p-4">
                        <div class="flex-grow">
                            <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900 dark:text-gray-100">${step.location} <span class="${typeColor} text-xs font-medium mr-2 px-2.5 py-0.5 rounded ml-3">${step.type}</span></h3>
                            <div class="mb-2 text-sm text-gray-500 dark:text-gray-400">Via: ${step.teleport}</div>
                            <p class="mb-2 text-gray-600 dark:text-gray-300 text-sm">${step.desc}</p>
                        </div>
                    </div>`;
                stepEl.innerHTML = `<span class="absolute flex items-center justify-center w-8 h-8 bg-white dark:bg-gray-600 rounded-full -left-4 border border-gray-300 dark:border-gray-500 font-bold text-gray-500 dark:text-gray-300">${stepCount}</span>` + content;
                
                container.appendChild(stepEl);
                const rowDiv = stepEl.querySelector('.interactive-row');
                rowDiv.addEventListener('click', () => {
                    rowDiv.classList.toggle('completed');
                    updateProgress();
                });
            });
        }

        function renderReference() {
            const container = document.getElementById('route-container');
            container.innerHTML = '';
            
            const createSection = (title, data, showPay) => {
                const div = document.createElement('div');
                div.className = "mb-8";
                div.innerHTML = `<h3 class="text-xl font-bold text-[#3d5c25] dark:text-green-400 mb-2">${title}</h3>`;
                
                const sortedData = [...data].sort((a,b) => a.lvl - b.lvl);

                const table = document.createElement('table');
                table.className = "ref-table text-gray-800 dark:text-gray-200";
                
                const thead = document.createElement('thead');
                thead.innerHTML = `<tr><th>Level</th><th>Tree</th>${showPay?'<th>Payment</th>':''}</tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                sortedData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "dark:border-gray-700";
                    tr.innerHTML = `<td>${item.lvl}</td><td>${item.name}</td>${showPay?`<td>${item.payQty} ${item.payItem}</td>`:''}`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                div.appendChild(table);
                container.appendChild(div);
            };

            const refHerbs = [
                { lvl: 9, name: "Guam" }, { lvl: 14, name: "Marrentill" }, { lvl: 19, name: "Tarromin" },
                { lvl: 26, name: "Harralander" }, { lvl: 32, name: "Ranarr" }, { lvl: 38, name: "Toadflax" },
                { lvl: 44, name: "Irit" }, { lvl: 50, name: "Avantoe" }, { lvl: 56, name: "Kwuarm" },
                { lvl: 62, name: "Snapdragon" }, { lvl: 67, name: "Cadantine" }, { lvl: 73, name: "Lantadyme" },
                { lvl: 79, name: "Dwarf Weed" }, { lvl: 85, name: "Torstol" }
            ];

            createSection("üåø Herbs", refHerbs, false);
            createSection("üå≤ Wood Trees", TREES.wood, true);
            createSection("üçé Fruit Trees", TREES.fruit, true);
            createSection("üå¥ Hardwood & Special", [...TREES.hardwood, ...TREES.calquat, ...TREES.crystal, ...TREES.celastrus, ...TREES.redwood], true);
        }

        function updateProgress() {
            const total = document.querySelectorAll('.interactive-row').length;
            const checked = document.querySelectorAll('.interactive-row.completed').length;
            const pct = total === 0 ? 0 : Math.round((checked / total) * 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('progress-text').innerText = `${pct}%`;
        }

        function updateStats() {
            if(currentMode === 'herb') {
                const level = currentFarmingLevel;
                let base = 6 + (level/20);
                const compost = document.getElementById('compost-select').value;
                if(compost === 'ultra') base += 2; else base += 1;
                chartInstance.data.labels = ['Disease Free (4)', 'Standard (6)'];
                chartInstance.data.datasets[0].label = 'Herbs';
                chartInstance.data.datasets[0].data = [(4*base).toFixed(1), (6*base*0.9).toFixed(1)];
                chartInstance.data.datasets[0].backgroundColor = ['#4ade80', '#fbbf24'];
            } else if (currentMode === 'tree') {
                const wood = getBestTree('wood', currentFarmingLevel);
                const fruit = getBestTree('fruit', currentFarmingLevel);
                const hard = getBestTree('hardwood', currentFarmingLevel);
                const calq = getBestTree('calquat', currentFarmingLevel);

                const woodXp = wood ? wood.xp * 7 : 0;
                const fruitXp = fruit ? fruit.xp * 7 : 0;
                const hardXp = hard && currentFarmingLevel >= 35 ? hard.xp * 5 : 0;
                const calqXp = calq && currentFarmingLevel >= 72 ? calq.xp * 3 : 0;

                chartInstance.data.labels = ['Wood (7)', 'Fruit (7)', 'Calquat (3)', 'Hardwood (5)'];
                chartInstance.data.datasets[0].label = 'Total XP';
                chartInstance.data.datasets[0].data = [woodXp.toFixed(0), fruitXp.toFixed(0), calqXp.toFixed(0), hardXp.toFixed(0)];
                chartInstance.data.datasets[0].backgroundColor = ['#a52a2a', '#ffa500', '#fcd34d', '#7f1d1d'];
            }
            updateChartTheme();
            chartInstance.update();
        }

        function updateChartTheme() {
            if (chartInstance) {
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e5e7eb' : '#374151';
                chartInstance.options.scales.x.ticks.color = textColor;
                chartInstance.options.scales.y.ticks.color = textColor;
                chartInstance.options.plugins.legend.labels.color = textColor;
                chartInstance.update();
            }
        }

        function toggleTheme(toggle = true) {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            let isDark = html.classList.contains('dark');
            if(toggle) {
                isDark = !isDark;
                isDark ? html.classList.add('dark') : html.classList.remove('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            } else {
                const saved = localStorage.getItem('theme');
                if(saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    html.classList.add('dark'); isDark = true;
                }
            }
            icon.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            updateChartTheme();
        }

        init();
    </script>
</body>
</html>
